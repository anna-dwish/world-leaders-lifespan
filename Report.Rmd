---
title: "Report"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
date: "8/23/2020"
fontsize: 12pt
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output: 
  pdf_document:
     latex_engine: xelatex
     number_sections: true
---
```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r include=FALSE}
#Installing packages 
pkgTest("tidyverse")
pkgTest("knitr")
pkgTest("kableExtra")
pkgTest("stringr")
pkgTest("coda")
pkgTest("tidybayes")

#Installing packages 
pkgTest("readr")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("Epi")
pkgTest("knitr")
pkgTest("lubridate")
pkgTest("R2jags")
pkgTest("tidyr")
pkgTest("kableExtra")
pkgTest("tibble")
pkgTest("tidybayes")
```


```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(stringr)
library(coda)
library(tidybayes)
library(readr)
library(dplyr)
library(ggplot2)
library(Epi)
library(knitr)
library(lubridate)
library(R2jags)
library(tidyr)
library(kableExtra)
library(tibble)
library(tidybayes)
```

```{r }
load("Leaders.Rdata")
leaders <- as.data.frame(leaders)
#head(leaders)
prev_date <- as.Date("31/07/2020",format="%d/%m/%Y")
current_date <- as.Date("31/08/2020",format="%d/%m/%Y")

## remove days string and convert to numeric
leaders <- leaders %>% 
  mutate(Age.Event = sub(".*?(\\d+\\.*\\d*).*", "\\1", Age.Event)) %>% data.frame
leaders$Age.Event <- as.numeric(leaders$Age.Event)

## update age event by adding 1/12 to leaders still alive (none died in past month so easy to do case when)
leaders <- leaders %>% 
  mutate(Age.Event = case_when(Event.Date == prev_date ~ Age.Event + 1/12,
                               TRUE ~ Age.Event)) %>% data.frame

## update event dates to be current day since none of the leaders in this set died in the past month
leaders <- leaders %>% 
  mutate(Event.Date = case_when(Event.Date == prev_date ~ as.Date(current_date,format="%d/%m/%Y"),
                                TRUE ~ Event.Date)) %>% data.frame

## update Emperor Jianwen
leaders <- leaders %>% 
  mutate(Fail = case_when(Name == "Jianwen Emperor" ~ 1,
                          TRUE ~ Fail),
         Censored = case_when(Name == "Jianwen Emperor" ~ 0,
                              TRUE ~ Censored)) %>% data.frame

## multiplying time by 10 
leaders <- leaders %>% 
  mutate(decade = time * 10)
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
filtered_leaders = leaders %>% 
  filter(!Name %in% alive)

load("leaders_model_r_25_2e-1_beta_1.Rdata")
Bayesian_Leaders_output <- rjags_model
```

# Introduction 

Because world leaders have measurable influence in politics, even beyond their election terms, it is critical to explore their life expectancies. Using data from 177 world leaders, including Roman Catholic Popes, U.S. Presidents, Chinese and Japanese Emperors, and Dalai Lamas, we model the leaders’ life expectancies using a Weibull distribution within a Bayesian framework. Our goal is to ultimately explore relationships with year of birth and type of leadership when predicting lifespan, as well as how dependent the relationships are on the type of leadership. We contend that, in providing point and interval predictions of the lifespans of living leaders, along with predictive distributions, we can make empirical comparisons between the survival times of world leaders. Our work extends the investigation from Stander et al. (2018) regarding post-election survival times of Popes, which urged researchers to consider other world leaders in their approach to understand survival analysis. 

# Data 

To address the above research objectives, we analyzed data on the survival time of 177 world leaders. Leaders in this dataset range from Pope Gregory XII, born in 1325, to President Obama, born in 1961. Survival time was defined to be either the leader’s current age, if alive, or age of death, if deceased. The 10 leaders in the dataset that are currently alive are considered right censored observations -- that is, we cannot know their exact age of death, but do know their current age. 

Covariates of interest in this study are *type* and *time*. Type is a categorical variable corresponding to the 5 varieties of world leaders in this dataset. Of the Type levels, Popes are the most represented in the dataset with 63 observations. In contrast, Dalai Lamas comprise the smallest group, with only 14 instances. The Time covariate represents the leader’s year of birth, measured as the number of centuries since 1300. For example, as Pope Francis was born roughly 637 years after January 1, 1300, his time value is represented as 6.37. We opted for this shifted and scaled version of birth year in order to prevent larger year values (1961, for example) from risking model instability. 

Below we will present some preliminary visualizations regarding our covariates of interest and survival outcome. In these visualizations, we use the term **transformed birth year** to refer to the time covariate, in order to provide a more intuitive understanding. First, we will look at the distribution of lifespan across the 177 world leaders. 

## Distributions of Lifespan

```{r}
ggplot(leaders, aes(x=Age.Event)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Lifespan") + xlab("Lifespan (yrs)") + geom_vline(xintercept = median(leaders$Age.Event), color = "red") + annotate(geom = "text", x = 83, y = 45, label = "median: 67.5")
```

We see that lifespan follows a left skewed distribution with a median value of 67.5 (indicated in red). Next, we will look at box plot distributions of transformed birth year by leadership type. 

## Distribution of Transformed Birth Year by Leadership Type
```{r}
boxplot(time ~ Type, data = leaders, main="Distribution of Transformed Birth Year by Type of Leader", ylab="Transformed Birth Year", xlab="Leader Type")
```

Among the Chinese Emperors, Japanese Emperors, and Dalai Lamas, the interquartile ranges of median lifespan largely overlap. As can be seen, popes and U.S. presidents appear to have a slightly higher median lifespan relative to Chinese Emperors, and Dalai Lamas. Finally, we will examine the relationship between lifespan and birth year for each type of leadership.

## Interaction Plot
```{r}
ggplot(leaders, aes(x=time, y=Age.Event, shape=Type, color=Type)) +
  geom_point() + labs(title="Lifespan vs Transformed Birth Year") + 
  ylab("Lifespan (yrs)") + xlab("Transformed Birth Year") +geom_smooth(method = "lm", se=FALSE)
```

It appears as though lifespan over time has increased at similar rates across Chinese Emperors, Japanese Emperors, US Presidents, and Popes. However, for the Dalai Lamas, the plot indicates that lifespan has decreased over time. This unexpected trend can be attributed to the untimely demise of several Dalai Lamas in the 19th and 20th centuries, with causes of death ranging from common illnesses to ceiling collapses [1] . 

# Methodology

## Model Selection 

We propose a Weibull distribution to model the survival time $T_i$ for the $i$th leader. This distribution is a more flexible generalization of the exponential distribution that can be used to model survival outcomes. The Weibull probability density function for $T_i$ takes the following form:

$$
f_{T_i}(t_i|r, \mu_i) = r\ \mu_i\ t_i^{r-1}\ exp(-\mu_i\ {t_i}^r),\ \ \ \ \ r,\  \mu_i, \ t_i >0
$$

The first parameter $r > 0$ of the Weibull distribution is a positive scale parameter, and is constant across all leaders. We then take the log of the second parameter, $\mu_i > 0$, as a linear function of the $time$ and $type$ covariates. For ease of interpretability, the $time$ covariate was mean-centered.

Our proposed model is as follows: 

$$
\begin{aligned}
T_i \sim & \,Weibull(r, \mu_i)  \\
log(\mu_i) = \beta_0 + \beta_1\ time_i + \sum_{j=2}^{5} \beta_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \beta_{3j}\  I(type_i = j)*time_i\ , &(1.1)
\end{aligned}
$$
where log is base $e$.

In Model 1.1, $i$ corresponds to each world leader and $T_i$ refers to their life expectancy. $time_i$ is the covariate representing birth year, measured in the number of centuries after 1300 that each leader was born, while $type_i$ refers to the individual's type of leadership. The reference level $j = 1$ for the $type$ covariate is Pope, as it forms the largest category ($n=63$). The remaining levels $j = 2, 3, 4, 5$ correspond to Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President respectively. The third term in the linear combination of covariates represents an interaction effect between $type$ and $time$. This interaction is used to account for  differences in the relationship between survival time and birth year that may exist across leadership types. 

To account for censored observations, we sample $T_i$ from a truncated distribution, $T_i \sim  \,Weibull(r,\, \mu_i)\,T(present\_age_i, \, upper\_age)$. $present\_age_i$ is 0 for a leader who is deceased and their current age if they are still alive. For deceased leaders, the lower bound of 0 prevents the model from making assumptions about the lifespan of that leader. For leaders who are currently alive, it ensures the model does not sample a survival time that is less than their current age. We set the $upper_age$ to be 110. We selected this upper bound due to the fact that the United Nations predicts that only 0.0074% of the world's population will celebrate their 100th birthday and become a centenarian(https://population.un.org/wpp/Download/Standard/Population/). Of this small percentage of people, the Gerontology Research Group estimates only 0.15% to 0.25% will reach the age of 110(http://supercentenarian-research-foundation.org/TableE.aspx). 

When modeling survival time $T_i$ in this manner, it can be shown that the log mean of $T_i$ is a linear function of the covariates of interest. Specifically, 

$$
\begin{aligned}
log(mean[T_i]) =  \alpha_0 + \alpha_1\ time_i + \sum_{j=2}^{5} \alpha_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \alpha_{3j}\  I(type_i = j)\ *time_i\
\end{aligned}
$$
where $\alpha_j = \frac{\beta_j}{r}$ for all j. This parameterization will be useful in making meaningful interpretations. When exponentiating both sides, for example, we can see that an increase in one unit of $time_i$ (which in our context, would correspond to an increase in century) results in a multiplicative change  of $exp(\alpha_1)$ in the mean survival time. This type of interpretation will be used later in this paper in order to properly quantify the effects of $time$ and $type$ on lifespan. 

## Choice of Prior Distributions

In our initial model, we adopted the following prior distributions for $r, \beta_1, \beta_{2j}$ and $\beta_{3j}$, for  $j = 2, 3, 4, 5$: 

$$
\begin{aligned}
&r \sim  \Gamma(25, 0.2)\\ 
\beta_0,\ \beta_1,\ &\beta_{2j},\ \beta_{3j} \sim N(0, 1), \ \ \ \  j = 2, 3, 4, 5
\end{aligned}
$$

Though there does not exist a strong body of literature to inform these priors, each of our choices resulted from research and consideration of context. For the prior on the $B_1$, the coefficient corresponding to the $time$ covariate, we decided to use a $N(0, 1)$ prior. We were motivated to explore this zero-centered, low variance prior due to a study [] citing that lifespan has not significantly changed over the past several centuries. Thus, this prior  reflects our beliefs that birth year does not change survival time by a large value. For the priors on $\beta_{2j}$, $j = 2,3,4,5$, which are coefficients for each of the 4 levels of $type$ (Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President), we observed that each leader type is tied to a region. Our research on lifespans across these various regions [1] indicates that they are roughly comprable, informing a $N(0,1)$ prior for each leader coefficient. We similarly chose a $N(0,1)$ prior for the interaction coefficients $\beta_{3j}$, $j = 2,3,4,5$. Here, we did not have a strong enough belief that the coefficients were non-zero and thus chose the same prior as that of the main effects.

Our prior on r, the positive scale parameter of the Weibull distribution, was informed by the context of the study. R values between 0 and 1 indicate a decreasing rate of failure over time, while those greater than 1 represent an increasing rate of failure. As can be assumed that the rate of death for world leaders increases with age, we assume an r value greater than 1. This warranted an informative Gamma (25, 0.2) prior with mean 5 and variance 1, reflecting  our certainty of R being a value greater than 1.

## Model Validation

We fit our initial model on the data to obtain posterior values for our parameters $r ,\beta_0, \beta_1, \beta_{2j}$ and $\beta_{3j}$. We perform  model diagnostics to ensure our parameter values have converged, which suggested that 250,000 simulated values were sufficient. Finally, we performed sensitivity analysis.

# Results 

## Summary of Parameters And Interpretations

```{r}
post_summary_df <- Bayesian_Leaders_output$BUGSoutput$summary %>% 
  as.data.frame() 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)
post_summary_df <- post_summary_df[rows,]
post_summary_df <- post_summary_df %>% 
  tibble::rownames_to_column("Parameter") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  mutate("95% CI" = paste0("(", `2.5%`, ", ", `97.5%`,  ")")) %>% 
  select(-(`2.5%`:`97.5%`)) %>% 
  select(Parameter, mean, sd, `95% CI`) 
post_summary_df$Parameter <- c("r", "(Intercept)", "Time", "Pope", "ChinaEmp", "DalaiLama", "JapanEmp", "UsPres",
                               "Pope*Time", "ChinaEmp*Time", "DalaiLama*Time", "JapanEmp*Time", "UsPres*Time")

post_summary_df %>% 
  mutate(mean = ifelse((mean == 0 & sd == 0), "(Reference)", mean),
         sd = ifelse((mean == "(Reference)" & sd == 0),"", sd),
         `95% CI` = ifelse((mean == "(Reference)" & sd == ""), "", `95% CI`)#,
         #Rhat = ifelse((mean == "(Reference)" & sd == ""), "", Rhat)
  ) %>% 
  kableExtra::kable(booktabs = T, caption = "Parameters obtained with Model 1.1, with 95\\% Credible Intervals (CI)",
                    col.names = c("Parameter", "Mean", "Std. Dev.", "95% CI"#, "Rhat"
                    )) %>% 
  #kable_styling(font_size = 10) %>% 
  
  pack_rows("Type", 4,8) %>% 
  pack_rows("Type*Time", 9,13)
```

Using JAGS, we ran Model 1.1 with 250,000 simulations to determine the posterior density $\pi(r, \beta_0, \beta_1, \beta_{2j}, \beta_{3j}\, | \,data)$, with results summarized in Table 1. The 95% credible interval is created using the 2.5%  and 97.5% quantiles.


Our model for survival time can be reparameterized in such a way that eases interpretability. Specifically, the log mean of $T_i$ can be written as linear function of our covariates of interest: 

$$
\begin{aligned}
log(mean[T_i]) =  \alpha_0 + \alpha_1\ time_i + \sum_{j=2}^{5} \alpha_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \alpha_{3j}\  I(type_i = j)\ *time_i\
\end{aligned}
$$

where $\alpha_j = \frac{\beta_j}{r}$ for all j. When exponentiating both sides of this expression, we observe that an increase in one unit of $time$ results in a multiplicative change of $exp(\alpha_1)$ in the mean survival time for a Pope. We can further compute the *percentage* increase in the mean survival time of a Pope given a unit increase in $time$ by computing $100{exp(\_alpha_1) − 1}$ 1}. A similar computation can be performed to understand the effect of increasing time on mean survival time across leader types. This provides an interpretable quantification of the interaction term, $type*time$ appearing in the expression for $log(mu)$.

Below, we summarize the multiplicative and percent changes in the mean survival time resulting from a decade increase in birth year for each leader type. Recall that $time$ is a scaled and shifted version of birth year that is measured in centuries. We thus consider the changes resulting from a 0.1 unit increase in $time$ in order to make interprations on a decade scale. 

```{r}
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()

#Pope
pope_alpha <- c(model$`2.5%`[2], model$mean[2], model$`97.5%`[2])
pope_multiplicative_difference <- exp(0.1*pope_alpha)
pope_percent_difference <- 100*(pope_multiplicative_difference - 1)


#Chinese Emperors
ce_alpha <- c(model$`2.5%`[2] + model$`2.5%`[3], model$mean[2] + model$mean[3], model$`97.5%`[2] + model$`97.5%`[3])
ce_multiplicative_difference <- exp(0.1*ce_alpha)
ce_percent_difference <- 100*(ce_multiplicative_difference - 1)

#Dalai Lama
dl_alpha <- c(model$`2.5%`[2] + model$`2.5%`[4], model$mean[2] + model$mean[4], model$`97.5%`[2] + model$`97.5%`[4])
dl_multiplicative_difference <- exp(0.1*dl_alpha)
dl_percent_difference <- 100*(dl_multiplicative_difference - 1)

#Japanese Emperor

je_alpha <- c(model$`2.5%`[2] + model$`2.5%`[5], model$mean[2] + model$mean[5], model$`97.5%`[2] + model$`97.5%`[5])
je_multiplicative_difference <- exp(0.1*je_alpha)
je_percent_difference <- 100*(je_multiplicative_difference - 1)

#US Presidents

us_alpha <- c(model$`2.5%`[2] + model$`2.5%`[6], model$mean[2] + model$mean[6], model$`97.5%`[2] + model$`97.5%`[6])
us_multiplicative_difference <- exp(0.1*us_alpha)
us_percent_difference <- 100*(us_multiplicative_difference - 1)


Type <- c("Pope", "Chinese Emperor", "Dalai Lama", "Japanese Emperor", "US President")
Multiplicative_Scale_Factor <- data.frame(Type, t(data.frame(pope_multiplicative_difference, ce_multiplicative_difference, dl_multiplicative_difference, je_multiplicative_difference, us_multiplicative_difference))) 
Percent_Difference <- data.frame(Type, t(data.frame(pope_percent_difference, ce_percent_difference, dl_percent_difference, je_percent_difference, us_percent_difference)))

bind_rows(Multiplicative_Scale_Factor,
          Percent_Difference) %>% 
  tibble::rownames_to_column() %>% 
  mutate_if(is.numeric, round, digits=3) %>% 
  mutate(Mean = X2, 
         `95% CI` = paste0("(", X1, ", ", X3, ")")) %>% 
  select(-(X1:X3), -rowname) %>% 
  kableExtra::kable(booktabs = TRUE, 
                    caption = "Posterior Predictions for Lifespans of Living Leaders", 
                    col.names = c("Leadership Type", "Mean", "95% CI")) %>% 
  pack_rows("Multiplicative Difference", 1,5) %>% 
  pack_rows("Percent Difference", 6,10)
```

These values indicate that, barring the Dalai Lamas, as birth year increases by a decade, the expected survival time increases as well. For United States presidents, a decade increase in birth year results in the greatest expected percentage increase in surival time, at 1.18%. For Popes, Chinese Emperors, and Japanese Emperors, the expected increases are slightly more modest, hovering around 0.3%. In contrast, the expect survival time change for a decade increase in birth year for the Dalai Lama is -1.54%. This is consistent with the string of successive early deaths among these leaders that occurred in the 19th and 20th centuries.


## Model Diagnostics 

We perform several model diagnostics to assess model integrity. The following traceplots and $\hat{R}$[1] (maybe add source for GElman and Rubin) suggest that the chains for each parameter have converged and mix well, while the autocorrelation plots indicate a low correlation between the simulations. (maybe include plots, maybe not)

### Convergence & Autocorrelation Plots 

```{r}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), r, beta_0, beta_1) %>% 
  ungroup() %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta[0], ", ", beta[1], ", r")), 
       x = "Iteration", y = "Value",  color = "Chain")
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_type[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["2j"], " (coefficients for Type)")), 
       x = "Iteration", y = "Value",  color = "Chain")
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_int[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["3j"], " (coefficients for Type * Time)")), 
       x = "Iteration", y = "Value",  color = "Chain")
plot_acf <- function(parameter) {
  Bayesian_Leaders_output$BUGSoutput$sims.matrix %>% 
    as_tibble() %>% 
    pull(parameter) %>% 
    acf(main = paste0("Lag-1 Autocorrelation for ", parameter))
}
for (param in c("r","beta_0", "beta_1",
                "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]", 
                "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]")) {
  plot_acf(param)
}
```

### Convergence & Autocorrelation Plots 
To determine if our model has converged sufficiently, we first examine traceplots for each of the parameter values. A traceplot with random scatter around a mean value indicates that the model has converged. $\hat{R}$ provides an estimate of convergence based on the variance of an estimated parameter between chains, and the variance wtihin a chain. The closer the $\hat{R}$ value to 1, the better the model has converged. Visually, we see that our chains have mixed well and that the $\hat{R}$ values are  all very close to 1, indicating that our model has sufficiently converged. 

To determine if our model has reached a stationary distribution, we first looked at autocorrelation plots because each simulation in the MCMC process is serially corrleated with the previous simulations. The lag-1 autocorrelation plots peak at the beginning and then bounce around 0. In addition, $n_{eff}$ gives a measure of effective sample size. Ideally, we want this number to equal the number of posterior draws, or be at least 200. The autocorrelation plots and large $n_eff$ values indicate that our MCMC process has sufficiently reached a stationary distribution. 

```{r}
rhat_neff = Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(Rhat, `n.eff`) 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)
rhat_neff[rows,]
```

### Sensitivity Analysis 

```{r}
r_vals <- c("1e-3", "1", "10_5e-1", "25_2e-1")
b_vals <- c("1", "100")
sensitivity_df = function(param) {
  df = data.frame()
  for (r in r_vals) {
    for (b in b_vals) {
      file_name = paste0("leaders_model_r_",r,"_beta_",b,".Rdata")
      load(file_name)
      
      param_df = rjags_model$BUGSoutput$sims.matrix %>% 
        as.data.frame() %>%
        select(param) %>% 
        mutate(r = case_when(
          r == "1e-3" ~ "0.001",
          r == "10_5e-1" ~ "10_0.5",
          r == "25_2e-1" ~ "25_0.2",
          TRUE ~ as.character(r)),
          priors = ifelse(str_detect(r, "_"),
                          paste0("r ~ Ga(", str_split(r, "_")[[1]][1], ", ", str_split(r, "_")[[1]][2], "), beta ~ N(0, ", b, ")"),
                          
                          paste0("r ~ exp(", r, "), beta ~ N(0, ", b, ")")
          ))
      df = df %>% bind_rows(param_df)
    }
  }
  
  return(df) 
}
Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(mean)
mean_vals <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(mean)
predicted_beta_1 <- c(mean_vals["beta_1",])

sensitivity_df("beta_1")  %>% 
  ggplot() + 
  geom_density(aes(x = beta_1)) + geom_vline(xintercept = predicted_beta_1, color = "red") + 
  labs(title = expression(paste("Sensitivity Analysis for Different Priors on r and ", beta))) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 

``` 

In the group of plots above, we explore the posterior distributions of $\beta_1$, the coefficient for our mean-centered time variable, that resulted from various priors. As we can see from the density plots above, the posterior distributions are roughly the same for four different r priors, each paired with two different priors on the beta coefficients. For both the r parameter and all of the beta coefficients, we made sure to explore non-informative priors, $exp(0.001)$ and $N(0,100)$, to validate that the results of our model are not specific to our prior choices. The red line indicates our posterior estimate of $\beta_1$.

### Residual Plots 

We also examined the standardized residuals. We define the standardized residual $std\_r_i = \frac{T_i - E[T_i]}{sd[T_i]}$ and $std\_r_i$ is plotted against $Time_i$. The plot shows that the standardized residuals are generally randomly dispersed about 0, where the censored observations are marked by a red X. 

```{r}
modelOutput <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame()
survivalPredicted <- modelOutput[211:383, ] %>% select("mean", "sd", "2.5%", "50%", "97.5%")
#creating dataframe with useful information (including prediction residuals and standardized residuals)
leader <- filtered_leaders$Name
censored_value <- as.factor(filtered_leaders$Censored)
actual_survival <- filtered_leaders$Age.Event
time <- filtered_leaders$time
survivalPredicted <- survivalPredicted %>%
  mutate(actual = actual_survival) %>%
  mutate(name = leader) %>%
  mutate(Censored = censored_value) %>%
  mutate(Standardized_Residual = (actual-mean)/sd) %>%
  mutate(Residual = actual-mean) %>%
  mutate(time_of_birth = time)
```

```{r}
#standardized residual plot
shapes = c(16, 4) 
shapes <- shapes[as.numeric(survivalPredicted$Censored)]
plot(y = survivalPredicted$Standardized_Residual, x = survivalPredicted$time_of_birth, col= survivalPredicted$Censored, pch = shapes, main = "Standardized Residuals vs Time", xlab = "Time", ylab = "Standardized Residuals")
abline(h =0)
legend("topleft", legend = c("Censored", "Non-Censored"),
       col =  c("black", "red"),
       pch = c(16, 4), cex = 0.75)
```

### Histograms and stuff 

# Discussion 

## Posterior Predictive Distribution 
```{r}
alive_leaders = leaders %>% 
  filter(Name %in% alive) %>% 
  bind_rows(filtered_leaders %>% 
              mutate(rownum = row_number()) %>% 
              filter(Censored == 1))

al_index = alive_leaders %>% 
  filter(!is.na(rownum)) %>% 
  pull(rownum) %>% 
  paste0("y_pred_censored[", ., "]") %>% 
  as.vector()

al_names = alive_leaders %>% pull(Name) %>% str_remove_all("\\s*\\([^\\)]+\\)")
al_cur_age = alive_leaders %>% pull(Age.Event)
al_type = alive_leaders %>% pull(Type)
Bayesian_Leaders_output$BUGSoutput$summary[c("survival_Francis",
                                            "survival_Obama",
                                            "survival_DL",
                                            "survival_Naruhito",
                                            al_index), ] %>%
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  mutate(rowname = al_names,
         cur_age = al_cur_age,
         type = al_type
         # ,
         # type = case_when(
         #   type == "DalaiLama" ~ "Dalai Lama", 
         #   type == "JapanEmp" ~ "Japanese Emperor", 
         #   type == "UsPres" ~  "US President", 
         #   TRUE ~ as.character(type))
  ) %>% 
  mutate_if(is.numeric, round, digits=3) %>% 
  mutate("95% CI" = paste0("(", `2.5%`,", ", `97.5%`, ")")) %>% 
  select(rowname, type,  cur_age, mean, `50%`, sd, "95% CI") %>% 
  kableExtra::kbl(booktabs = TRUE, caption = "Posterior Predictions for Lifespans of Living Leaders", 
                  col.names = c("Leader", "Type", "Current Age", "Mean", "Median", "Std. Dev.", "95% CI")) %>% 
  kable_styling(position = "center") %>% 
  row_spec(0, bold = TRUE) %>% 
  column_spec(column = c(3:7), latex_column_spec = "c") %>% 
  #kable_styling(position = "center", latex_options = c("hold_position")) %>% 
  # add_header_above(c(" " = 3, "Posterior Values" = 4)) %>% 
  row_spec(0:10, align = "c")

```

We will address our second goal of providing posterior predictions of the lifespans of living leaders. Since we set the upper bound of the truncated Weibull distribution to 110, we expected the upper tails of the 95% credible intervals to be near 110. This is the case for all the leaders expect the 14th Dalia Lama, whose 97.5% quantile is 99.16. As previously discussed, there was a string of early deaths among Dalai Lamas in the 19th century, which may have impacted the posterior predictions for the 14th Dalai Lama. Furthermore, Dalai Lamas represent the smallest group of leadership type ($n = 14$), which limits the prediction. 


```{r}
# probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis

survival_DL <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_DL"]
survival_Francis <-Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Francis"]

DL_vs_francis <- survival_DL - survival_Francis
DL_vs_francis_data <- as.data.frame(DL_vs_francis)
ggplot(DL_vs_francis_data, aes(x = DL_vs_francis, y = ..density..)) + geom_histogram(binwidth = 3) + labs(x = "Difference in Predicted Survival Times (Dali Lama - Francis)", y = "Predictive Probability density", title = "Distribution of Difference in Predicted Survival Times for Dali Lama and Pope Francis") +  theme_light() + geom_vline(xintercept=mean(DL_vs_francis), color = "blue")

```

In observing the posterior predictive samples for the survival times of the 14th Dalai Lama and Pope Francis, we note that only in  `100*mean(survival_DL>survival_Francis)`% of the simulated samples is the Dalai Lama is predicted to have a longer lifespan. Thus, there is only a `mean(survival_DL>survival_Francis)` probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis. In examining the posterior distribution of the differences between the predicted survival times of the two leaders (Dalai Lama - Francis), we note a mean of `mean(DL_vs_francis)` (shown by the blue line) and median of `median(DL_vs_francis)`, both well below zero. This indicates that, on average, the posterior predictions for the survival time of 14th Dalai Lama are `-1*mean(DL_vs_francis)` years below that of Pope Francis. 


```{r}
#probability that Obama will live longer thatn Naruhito

survival_Obama <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Obama"]
survival_Naruhito <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Naruhito"]

Obama_vs_naruhito <- survival_Obama - survival_Naruhito
Obama_vs_naruhito_data <- as.data.frame(Obama_vs_naruhito)
ggplot(Obama_vs_naruhito_data, aes(x = Obama_vs_naruhito, y = ..density..)) + geom_histogram(binwidth = 3) + labs(title ="Distribution of Difference in Predicted Survival Times for President Obama and Emperor Naruhito" ,x = "Difference in Predicted Survival Times (Obama - Naruhito)", y = "Predictive Probability density")  +  theme_light() + geom_vline(xintercept=mean(Obama_vs_naruhito), color = "blue") 
```

In observing the posterior predictive samples for the survival times of the President Obama and Emperor Naruhito, we note that in  `100*mean(survival_Obama > survival_Naruhito)` % of the simulated samples,  President Obama is predicted to have a longer lifespan. Consequently, there is  around a `mean(survival_Obama > survival_Naruhito)` probability that Obama  will have a longer lifespan than Naruhito. In examining the posterior distribution of the differences between the predicted survival times of the two leaders (Obama - Naruhito), we note a quite normal distribution with a mean of `mean(DL_vs_francis)`(shown by the blue line) and median of `median(DL_vs_francis)`, both close to zero. This indicates that, on average, the posterior predictions for the survival time of President Obama are only `mean(DL_vs_francis)` years above that of Emperor Naruhito. 

## Answering Questions 

# Conclusion & Limitations 

start off by summarizing answers to all the questions 

There are several limitations in our analysis. These include, but are not limited to, small sample size (as a whole and by leader type), lack of health-related covariates, underrepresentation of women, unavailability of studies that inform strong prior distributions, and the absence of informative covariates that represent type of death (i.e., the case of the four short-lived, 19th-century Dalai Lamas and the disappearance of Chinese Emperor Jianwen). These limitations greatly undermine the heterogenous notions of “world leaders”; for example, without including health covariates, this limits our empirical knowledge of world leaders and the availability of healthcare in certain areas during a specific time period.

# Appendix 

## Bibliography

1. Julian Stander, Luciana Dalla Valle & Mario Cortina-Borja (2018) A Bayesian Survival Analysis of a Historical Dataset: How Long Do Popes Live?, The American Statistician, 72:4, 368-375, DOI: 10.1080/00031305.2017.1328374
2. World Population Prospects - Population Division. (n.d.). Retrieved August 31, 2020, from https://population.un.org/wpp/Download/Standard/Population/
3. Supercentenarian Research Foundation. (n.d.). Retrieved August 31, 2020, from http://supercentenarian-research-foundation.org/TableE.aspx
4. Ruggeri, A. (2018, October 2). Do we really live longer than our ancestors? Retrieved August 31, 2020, from https://www.bbc.com/future/article/20181002-how-long-did-ancient-people-live-life-span-versus-longevity


#########################
where $\beta_0$ corresponds with the intercept, $\beta_1$ is the coefficient corresponding to `Time`, $\beta_{type} = (0, \beta_2, \beta_3, \beta_4, \beta_5)$ is the vector of coefficients corresponding to leadership types of Popes, Chinese Emperors, Dalai Lamas, Japanese Emperors, and US Presidents respectively, and $\beta_{type*time} = (0, \beta_6, \beta_7, \beta_8, \beta_9)$ is the vector of coefficient corresponding  to the interaction between `Time` and leadership type.



