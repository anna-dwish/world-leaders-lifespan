---
title: "Report"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
date: "8/23/2020"
fontsize: 12pt
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output: 
  pdf_document:
     latex_engine: xelatex
     number_sections: true
---
```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r include=FALSE}
#Installing packages 
pkgTest("tidyverse")
pkgTest("knitr")
pkgTest("kableExtra")
pkgTest("stringr")
pkgTest("coda")
pkgTest("tidybayes")

#Installing packages 
pkgTest("readr")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("Epi")
pkgTest("knitr")
pkgTest("lubridate")
pkgTest("R2jags")
pkgTest("tidyr")
pkgTest("kableExtra")
pkgTest("tibble")
pkgTest("tidybayes")
```


```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r }
library(tidyverse)
library(knitr)
library(kableExtra)
library(stringr)
library(coda)
library(tidybayes)
library(readr)
library(dplyr)
library(ggplot2)
library(Epi)
library(knitr)
library(lubridate)
library(R2jags)
library(tidyr)
library(kableExtra)
library(tibble)
library(tidybayes)
load("Leaders.Rdata")
leaders <- as.data.frame(leaders)
#head(leaders)
prev_date <- as.Date("31/07/2020",format="%d/%m/%Y")
current_date <- as.Date("31/08/2020",format="%d/%m/%Y")

## remove days string and convert to numeric
leaders <- leaders %>% 
  mutate(Age.Event = sub(".*?(\\d+\\.*\\d*).*", "\\1", Age.Event)) %>% data.frame
leaders$Age.Event <- as.numeric(leaders$Age.Event)

## update age event by adding 1/12 to leaders still alive (none died in past month so easy to do case when)
leaders <- leaders %>% 
  mutate(Age.Event = case_when(Event.Date == prev_date ~ Age.Event + 1/12,
                               TRUE ~ Age.Event)) %>% data.frame

## update event dates to be current day since none of the leaders in this set died in the past month
leaders <- leaders %>% 
  mutate(Event.Date = case_when(Event.Date == prev_date ~ as.Date(current_date,format="%d/%m/%Y"),
                                TRUE ~ Event.Date)) %>% data.frame

## update Emperor Jianwen
leaders <- leaders %>% 
  mutate(Fail = case_when(Name == "Jianwen Emperor" ~ 1,
                          TRUE ~ Fail),
         Censored = case_when(Name == "Jianwen Emperor" ~ 0,
                              TRUE ~ Censored)) %>% data.frame

## multiplying time by 10 
leaders <- leaders %>% 
  mutate(decade = time * 10)
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
filtered_leaders = leaders %>% 
  filter(!Name %in% alive)

load("leaders_model_r_25_2e-1_beta_1.rdata")
Bayesian_Leaders_output <- rjags_model
```


```{r out.width="50%"}
# load("leaders_model_r_1e-1_beta_100.Rdata")
# Bayesian_Leaders_V3b <- rjags_model
# bugs1 <- Bayesian_Leaders_V3b$BUGSoutput$summary %>% 
#   as.data.frame() 
# rows <- c("r", "beta_0", "beta_1", 
#           "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
#           "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
# )
# bugs1 <- bugs1[rows,]
# bugs1 <- bugs1 %>% 
#   tibble::rownames_to_column("Parameter") %>% 
#   mutate_if(is.numeric, round, digits = 3) %>% 
#   mutate("95% CI" = paste0("(", `2.5%`, ", ", `97.5%`,  ")")) %>% 
#   select(-(`2.5%`:`97.5%`)) %>%  
#   select(Parameter, mean, sd, `95% CI`, Rhat) 
# bugs1$Parameter <- c("r", "(Intercept)", "Time", "Pope", "ChinaEmp", "DalaiLama", "JapanEmp", "UsPres",
#                      "Pope*Time", "ChinaEmp*Time", "DalaiLama*Time", "JapanEmp*Time", "UsPres*Time")
# 
# bugs1 %>% 
#   mutate(mean = ifelse((mean == 0 & sd == 0), "(Reference)", mean),
#          sd = ifelse((mean == "(Reference)" & sd == 0),"", sd),
#          `95% CI` = ifelse((mean == "(Reference)" & sd == ""), "", `95% CI`),
#          Rhat = ifelse((mean == "(Reference)" & sd == ""), "", Rhat)) %>% 
#   kableExtra::kable(booktabs = T, caption = "$\\hat\\beta$s obtained with Model, with 95\\% Confidence Intervals (CI)",
#                   col.names = c("Parameter", "Estimate", "Std. Deviation", "95% CI", "Rhat")) %>% 
#   #kable_styling(font_size = 10) %>% 
#   
#   pack_rows("Type", 4,8) %>% 
#   pack_rows("Type*Time", 9,13)

#ggplot()
```



Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Introduction 

In an investigation of the post-election survival times of popes, Stander et al. (2018) highlighted predictive results from Bayesian analysis and urged researchers to consider other world leaders in their approach to understand survival analysis more critically. Our study extends this work by analyzing the survival times of 177 world leaders. These include Roman Catholic Popes, United States Presidents, Chinese Emperors, Japanese Emperors, and Dalai Lamas from 1325 to current day. 

In this paper, we discuss a Weibull distribution modelling the lifespan of world leaders. We  determine how year of birth and type of leadership are related to a leader’s lifespan, and if the relationship between year of birth and lifespan is dependent on the type of leadership. In addition, we will provide point and interval predictions of the lifespans of living leaders in our data as well as use their predictive distributions to make comparitive statements. 

# Data 

To address the above research objectives, we analyzed data on the life expectancy of 177 world leaders. Leaders in this dataset range from Pope Gregory XII, born in 1325, to President Obama, born in 1961. Life expectancy was defined to be either the leader’s current age, if alive, or age of death, if deceased. The 10 leaders in the dataset that are currently alive are considered right censored observations -- that is, we cannot know their exact age of death, but do know their current lifespan. 

Covariates of interest in this study are *type* and *time*. Type is categorical variable corresponding to the 5 varieties of world leader. Of the type levels, Popes are the most represented in the dataset with 63 observations. In contrast, Dalai Lamas comprise the smallest group, with only 14 instances. The time covariate represents the leader’s year of birth, measured as the number of centuries since 1300. For example, as Pope Francis was born roughly 637 years after January 1, 1300, his time value is represented as 6.37. We opted for this shifted and scaled version of birth year in order to prevent larger year values (1961, for example) from skewing estimates. 

Below we will present some preliminary visualizations regarding our covariates of interest and survival outcome. In these visualizations, we use the term **transformed birth year** to refer to the time covariate, in order to provide a more intuitive understanding.  First, we will look at the distribution of lifespan across the 177 world leaders. 



## Distributions of Lifespan

```{r}
ggplot(leaders, aes(x=Age.Event)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Lifespan") + xlab("Lifespan (yrs)") + geom_vline(xintercept = median(leaders$Age.Event), color = "red") + annotate(geom = "text", x = 83, y = 45, label = "median: 67.5")
```

We see that lifespan follows a left skewed distribution with a median value of 67.5 (indicated in red). Next, we will look at box plot distributions of transformed birth year by leadership type. 

## Distribution of Transformed Birth Year by Leadership Type
```{r}
boxplot(time ~ Type, data = leaders, main="Distribution of Transformed Birth Year by Type of Leader", ylab="Transformed Birth Year", xlab="Leader Type")
```

Among the Chinese Emperors, Japanese Emperors, and Dalai Lamas, the interquartile ranges of median lifespan largely overlap. As can be seen, popes and U.S. presidents appear to have a slightly higher median lifespan relative to Chinese Emperors, and Dalai Lamas. Finally, we will examine the relationship between lifespan and birth year for each type of leadership.

## Interaction Plot
```{r}
ggplot(leaders, aes(x=time, y=Age.Event, shape=Type, color=Type)) +
  geom_point() + labs(title="Lifespan vs Transformed Birth Year") + 
  ylab("Lifespan (yrs)") + xlab("Transformed Birth Year") +geom_smooth(method = "lm", se=FALSE)
```

It appears as though lifespan over time has increased at similar rates across Chinese Emperors, Japanese Emperors, US Presidents, and Popes. However, for the Dalai Lamas, the plot indicates that lifespan has decreased over time. This unexpected trend can be attributed to the untimely demise of several Dalai Lamas in the 19th and 20th centuries, with causes of death ranging from common illnesses to ceiling collapses [1] . 

# Methodology

## Model Selection 

We propose a Weibull distribution to model the life expectancy $T_i$ for the $i$th leader. This distribution is more flexible a generalization of the exponential distribution that can be used to model survival outcomes. The Weibull probability density function for $T_i$ takes the following form:

$$
f_{T_i}(t_i|r, \mu_i) = r\ \mu_i\ t_i^{r-1}\ exp(-\mu_i\ {t_i}^r),\ \ \ \ \ r,\  \mu_i, \ t_i >0
$$

The first parameter $r > 0$ of the Weibull distribution is a positive scale parameter, and is constant across all leaders. We then take the log of the second parameter, $\mu_i > 0$, as a linear function of the $time$ and $type$ covariates. For ease of interpretability, the $time$ covariate was mean-centered.

Our proposed model is as follows: 

$$
\begin{aligned}
T_i \sim & \,Weibull(r, \mu_i)  \\
log(\mu_i) = \beta_0 + \beta_1\ time_i + \sum_{j=2}^{5} \beta_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \beta_{3j}\  I(type_i = j)*time_i\ , &(1.1)
\end{aligned}
$$
where log is base $e$.

In Model 1.1, $i$ corresponds to each world leader and $T_i$ refers to their life expectancy. $time_i$ is the covariate representing birth year, measured in the number of centuries after 1300 that each leader was born, while $type_i$ refers to the individual's type of leadership. The reference level $j = 1$ for the $type$ covariate is Pope, as it forms the largest category ($n=63$). The remaining levels $j = 2, 3, 4, 5$ correspond to Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President respectively. The third term in the linear combination of covariates represents an interaction effect between $type$ and $time$. This interaction is used to account for  differences in the relationship between survival time and birth year that may exist across leadership types. 

To account for censored observations, we sample $T_i$ from a truncated distribution, $T_i \sim  \,Weibull(r,\, \mu_i)\,T(present\_age_i, \, upper\_age)$. $present\_age_i$ is 0 for a leader who is deceased and their current age if they are still alive. For deceased leaders, the lower bound of 0 prevents the model from making assumptions about the lifespan of that leader. For leaders who are currently alive, it ensures the model does not sample a life expectancy that is less than their current age. We set the $upper_age$ to be 110 - the United Nations predicts that only 0.0074% of the world's population will celebrate their 100th birthday and become a centenarian(https://population.un.org/wpp/Download/Standard/Population/), and the Gerontology Research Group estimates only 0.15% to 0.25% of centenarians will reach the age of 110(http://supercentenarian-research-foundation.org/TableE.aspx). 

When modelling survival time $T_i$ in this manner, it can be shown that the log mean of $T_i$ is a linear function of the covariates of interest. Specifically, 

$$
\begin{aligned}
log(mean[T_i]) =  \alpha_0 + \alpha_1\ time_i + \sum_{j=2}^{5} \alpha_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \alpha_{3j}\  I(type_i = j)\ *time_i\
\end{aligned}
$$
where $\alpha_j = \frac{\beta_j}{r}$ for all j. This parameterization will be useful in making meaningful interpretation. When exponentiating both sides, for example, we can see that an increase in one unit of $time_i$ (which in our context, would correspond to an increase in century) results in a multiplicative change  of $exp(\alpha_1)$ in the mean survival time. This type of interpretation will be used later in this paper in order to properly quantify the effects of $time$ and $type$ on lifespan. 

## Choice of Prior Distributions - OLD 

In our initial model, we adopted the following prior distributions for $r, \beta_1, \beta_{2j}$ and $\beta_{3j}$: 

$$
\begin{aligned}
&r \sim  \Gamma(25, 0.2)\\ 
\beta_0,\ \beta_1,\ &\beta_{2j},\ \beta_{3j} \sim N(0, 1), \ \ \ \  j = 2, 3, 4, 5
\end{aligned}
$$

Though there does not exist a strong body of literature to inform these priors, our choices resulted from research and consideration of context. For the prior on the $B_1$, the coefficient corresponding to the $time$ covariate, we decided to use a $N(0, 1)$ prior. We were motivated to explore this low variance prior closely centered around zero from a study [] citing that our lifespans do not significantly differ from those several centuries ago. Thus, 


Our prior on r, the positive scale parameter of the Weibull distribution, was informed by the context of the study. R values between 0 and 1 indicate a decreasing rate of failure over time, while those greater represent an increasing rate of failure. It can be assumed that the rate of death for world leaders increases with age-- equivalently, an r value greater than 1. This warranted an informative Gamma (25, 0.2) prior with mean 5 and variance 1, reflecting  our certainty of R being a value greater than 1. 

## Choice of Prior Distributions

In our initial model, we adopted the following prior distributions for $r, \beta_1, \beta_{2j}$ and $\beta_{3j}$, for  $j = 2, 3, 4, 5$: 

$$
\begin{aligned}
&r \sim  \Gamma(25, 0.2)\\ 
\beta_0,\ \beta_1,\ &\beta_{2j},\ \beta_{3j} \sim N(0, 1), \ \ \ \  j = 2, 3, 4, 5
\end{aligned}
$$

Though there does not exist a strong body of literature to inform these priors, each of our choices resulted from research and consideration of context. For the prior on the $B_1$, the coefficient corresponding to the $time$ covariate, we decided to use a $N(0, 1)$ prior. We were motivated to explore this zero-centered, low variance prior due to a study [] citing that lifespan has not significantly changed over the past several centuries. Thus, this prior  reflected our beliefs that time is not a significant determinant of survival. For the priors on $\beta_{2j}$, $j = 2,3,4, 5$, which are coefficients for each of the 4 levels of $type$ (Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President), we observed that each leader type is tied to a region. Our research on lifespans across these various regions [1] indicates that they are roughly comprable, informing a $N(0,1)$ prior for each leader coefficient. We similarly chose a $N(0,1)$ prior for the interaction coefficients $\beta_{3j}$, $j = 2,3,4,5$. Here, we did not have a strong enough belief that the coefficients were non-zero and thus chose the same prior as that of the main effects.

Our prior on r, the positive scale parameter of the Weibull distribution, was informed by the context of the study. R values between 0 and 1 indicate a decreasing rate of failure over time, while those greater than 1 represent an increasing rate of failure. As can be assumed that the rate of death for world leaders increases with age, we assume an r value greater than 1. This warranted an informative $\Gamma(25, 0.2)$ prior with mean 5 and variance 1, reflecting  our certainty of R being a value greater than 1.

## Model Validation

We fit our initial model on the data to obtain posterior values for our parameters $r ,\beta_0, \beta_1, \beta_{2j}$ and $\beta_{3j}$. We perform  model diagnostics to ensure our parameter values have convereged, which suggested that 200,000 simulated values were sufficient. Finally, we performed sensitivity analysis.

# Results 

## Summary of Parameters (AND interpretations)

```{r}
post_summary_df <- Bayesian_Leaders_output$BUGSoutput$summary %>% 
  as.data.frame() 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)
post_summary_df <- post_summary_df[rows,]
post_summary_df <- post_summary_df %>% 
  tibble::rownames_to_column("Parameter") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  mutate("95% CI" = paste0("(", `2.5%`, ", ", `97.5%`,  ")")) %>% 
  select(-(`2.5%`:`97.5%`)) %>% 
  select(Parameter, mean, sd, `95% CI`) 
post_summary_df$Parameter <- c("r", "(Intercept)", "Time", "Pope", "ChinaEmp", "DalaiLama", "JapanEmp", "UsPres",
                               "Pope*Time", "ChinaEmp*Time", "DalaiLama*Time", "JapanEmp*Time", "UsPres*Time")

post_summary_df %>% 
  mutate(mean = ifelse((mean == 0 & sd == 0), "(Reference)", mean),
         sd = ifelse((mean == "(Reference)" & sd == 0),"", sd),
         `95% CI` = ifelse((mean == "(Reference)" & sd == ""), "", `95% CI`)#,
         #Rhat = ifelse((mean == "(Reference)" & sd == ""), "", Rhat)
  ) %>% 
  kableExtra::kable(booktabs = T, caption = "Parameters obtained with Model 1.1, with 95\\% Credible Intervals (CI)",
                    col.names = c("Parameter", "Mean", "Std. Dev.", "95% CI"#, "Rhat"
                    )) %>% 
  #kable_styling(font_size = 10) %>% 
  
  pack_rows("Type", 4,8) %>% 
  pack_rows("Type*Time", 9,13)
```

Using JAGS, we run Model 1.1 with 150,000 simulations to determine the posterior density $\pi(r, \beta_0, \beta_1, \beta_{2j}, \beta_{3j}\, | \,data)$, with results summarized in Table 1. The 95% credible interval is created using the 2.5%  and 97.5% quantiles.


ADD TABLE OF INTERPRETATIONS 

## Model Diagnostics 

We perform several model diagnostics to assess model integrity. Traceplots and $\hat{R}$[1] (maybe add source for GElman and Rubin) suggest that the chains for each parameter have converged and mix well, and autocorrelation plots indicate a low correlation between the simulations. (maybe include plots, maybe not)

### Convergence & Autocorrelation Plots 

```{r}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), r, beta_0, beta_1) %>% 
  ungroup() %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta[0], ", ", beta[1], ", r")), 
       x = "Iteration", y = "Value",  color = "Chain")

tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_type[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["2j"], " (coefficients for Type)")), 
       x = "Iteration", y = "Value",  color = "Chain")

tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_int[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["3j"], " (coefficients for Type * Time)")), 
       x = "Iteration", y = "Value",  color = "Chain")

plot_acf <- function(parameter) {
  Bayesian_Leaders_output$BUGSoutput$sims.matrix %>% 
    as_tibble() %>% 
    pull(parameter) %>% 
    acf(main = paste0("Lag-1 Autocorrelation for ", parameter))
}
for (param in c("r","beta_0", "beta_1",
              "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]", 
                "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]")) {
  plot_acf(param)
}

```

To determine if our model has converged sufficiently, we first examine traceplots for each of the parameter values. A traceplot with random scatter around a mean value indicates that the model has converged. $\hat{R}$ provides an estimate of convergence based on the variance of an estimated parameter between chains, and the variance wtihin a chain. The closer the $\hat{R}$ value to 1, the better the model has converged. Visually, we see that our chains have mixed well and that the $\hat{R}$ values are  all very close to 1, indicating that our model has sufficiently converged. 

To determine if our model has reached a stationary distribution, we first looked at autocorrelation plots because each simulation in the MCMC process is serially corrleated with the previous simulations. The lag-1 autocorrelation plots peak at the beginning and then bounce around 0. In addition, $n_{eff}$ gives a measure of effective sample size. Ideally, we want this number to equal the number of posterior draws, or be at least 200. The autocorrelation plots and large $n_eff$ values indicate that our MCMC process has sufficiently reached a stationary distribution. 

```{r}
rhat_neff = Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(Rhat, `n.eff`) 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)

rhat_neff[rows,]
```


### Sensitivity Analysis 

```{r eval=FALSE}
r_vals <- c("1e-3", "1", "10_5e-1")
b_vals <- c("1", "100")
sensitivity_df = function(param) {
  df = data.frame()
  for (r in r_vals) {
    for (b in b_vals) {
      file_name = paste0("leaders_model_r_",r,"_beta_",b,".Rdata")
      load(file_name)
      
      param_df = rjags_model$BUGSoutput$sims.matrix %>% 
        as.data.frame() %>%
        select(param) %>% 
        mutate(r = case_when(
          r == "1e-3" ~ "0.001",
          r == "10_5e-1" ~ "10_0.5",
          r == "25_2e-1" ~ "25_0.2",
          TRUE ~ as.character(r)),
          priors = ifelse(str_detect(r, "_"),
                          paste0("r ~ Ga(", str_split(r, "_")[[1]][1], ", ", str_split(r, "_")[[1]][2], "), beta ~ N(0, ", b, ")"),
                          
                          paste0("r ~ exp(", r, "), beta ~ N(0, ", b, ")")
          ))
      df = df %>% bind_rows(param_df)
    }
  }
  
  return(df) 
}

sensitivity_df("beta_1")  %>% 
  ggplot() + 
  geom_density(aes(x = beta_1)) + 
  labs(title = expression(paste("Sensitivity Analysis for Different Priors on r and ", beta))) + 
  facet_wrap(priors~.,  scales = "free", nrow = 2) 

``` 

### Residual Plots 

### Histograms and stuff 

# Discussion 

## Posterior Predictive Distribution 

```{r}
# tidybayes::gather_draws(Bayesian_Leaders_V7a %>% as.mcmc(), survival_Francis,
#                         survival_Obama,
#                         survival_Naruhito,
#                         survival_DL) %>% 
#   ungroup() 

# Bayesian_Leaders_output$BUGSoutput$summary[c("survival_Francis",
#                                             "survival_Obama",
#                                             "survival_Naruhito",
#                                             "survival_DL"), ] %>% 
#   as.data.frame() %>% 
#   tibble::rownames_to_column() %>% 
#   mutate(rowname = str_remove_all(rowname, "survival_"),
#          rowname = case_when(
#            rowname == "Francis" ~ "Pope Francis",
#            rowname == "Obama" ~ "President Obama",
#            rowname == "Naruhito" ~ "Emperor Naruhito",  
#            rowname == "DL" ~ "14th Dalai Lama"
#          )) %>% 
#   mutate_if(is.numeric, round, digits=3) %>% 
#   mutate("95% CI" = paste0("(", `2.5%`,", ", `97.5%`, ")")) %>% 
#   select(rowname, mean, `50%`, sd, "95% CI") %>% 
#   kableExtra::kable(booktabs = T, caption = "$\\hat\\beta$s obtained with Model, with 95\\% Credible Intervals (CI)",
#                   col.names = c("Leader", "Mean", "Median", "Std. Deviation", "95% CI"
#                   )) 

alive_leaders = leaders %>% 
  filter(Name %in% alive) %>% 
  bind_rows(filtered_leaders %>% 
              mutate(rownum = row_number()) %>% 
              filter(Censored == 1))

al_index = alive_leaders %>% 
  filter(!is.na(rownum)) %>% 
  pull(rownum) %>% 
  paste0("y_pred_censored[", ., "]") %>% 
  as.vector()

al_names = alive_leaders %>% pull(Name) %>% str_remove_all("\\s*\\([^\\)]+\\)")
al_cur_age = alive_leaders %>% pull(Age.Event)
al_type = alive_leaders %>% pull(Type)
Bayesian_Leaders_output$BUGSoutput$summary[c("survival_Francis",
                                            "survival_Obama",
                                            "survival_DL",
                                            "survival_Naruhito",
                                            al_index), ] %>%
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  mutate(rowname = al_names,
         cur_age = al_cur_age,
         type = al_type
         # ,
         # type = case_when(
         #   type == "DalaiLama" ~ "Dalai Lama", 
         #   type == "JapanEmp" ~ "Japanese Emperor", 
         #   type == "UsPres" ~  "US President", 
         #   TRUE ~ as.character(type))
  ) %>% 
  mutate_if(is.numeric, round, digits=3) %>% 
  mutate("95% CI" = paste0("(", `2.5%`,", ", `97.5%`, ")")) %>% 
  select(rowname, type,  cur_age, mean, `50%`, sd, "95% CI") %>% 
  kableExtra::kable(booktabs = TRUE, caption = "Posterior Predictions for Lifespans of Living Leaders", 
                    col.names = c("Leader", "Type", "Current Age", "Mean", "Median", "Std. Dev.", "95% CI")) %>% 
  kable_styling(position = "center") %>%  
  row_spec(0, bold = TRUE) %>% 
  column_spec(column = c(3:7), latex_column_spec = "c") %>% 
  #kable_styling(position = "center", latex_options = c("hold_position")) %>% 
  add_header_above(c(" " = 3, "Posterior Values" = 4)) 

```

## Posterior Predictions of Life Expectancies for Select Leaders 

```{r}
# probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis

survival_DL <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_DL"]
survival_Francis <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Francis"]


DL_vs_francis <- survival_DL - survival_Francis
diffData <- as.data.frame(DL_vs_francis)
ggplot(diffData, aes(x = DL_vs_francis, y = ..density..)) + geom_histogram(binwidth = 3) + labs(x = "Difference in Predicted Survival Times between Dalai Lama and rancisPredictive Probability density", title = "Figure 4") 


#probability that Obama will live longer thatn Naruhito

survival_Obama <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Obama"]
survival_Naruhito <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Naruhito"]

mean(survival_Obama > survival_Naruhito)
med <- median(survival_Obama > survival_Naruhito)

Obama_vs_naruhito <- survival_Obama - survival_Naruhito
diffData <- as.data.frame(Obama_vs_naruhito)
ggplot(diffData, aes(x = Obama_vs_naruhito, y = ..density..)) + geom_histogram(binwidth = 3) + labs(x = "Difference in Predicted Survival Times between Obama and Naruhito", y = "Predictive Probability density", title = "Figure 4") 
```

# Conclusion & Limitations 

start off by summarizing answers to all the questions 

#########################
where $\beta_0$ corresponds with the intercept, $\beta_1$ is the coefficient corresponding to `Time`, $\beta_{type} = (0, \beta_2, \beta_3, \beta_4, \beta_5)$ is the vector of coefficients corresponding to leadership types of Popes, Chinese Emperors, Dalai Lamas, Japanese Emperors, and US Presidents respectively, and $\beta_{type*time} = (0, \beta_6, \beta_7, \beta_8, \beta_9)$ is the vector of coefficient corresponding  to the interaction between `Time` and leadership type.

