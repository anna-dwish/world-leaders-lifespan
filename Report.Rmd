---
title: "Case Study 1: Lifespans of World Leaders"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
fontsize: 12pt
geometry: "left=1.5cm,right=1.5cm,top=1.5cm,bottom=1.5cm"
output: 
  pdf_document:
     latex_engine: xelatex
     number_sections: true
---
```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r include=FALSE}
# Installing packages 
# Additionally, if you are struggling to download RJags, please visit the following link for help. It can also help to try to download the package locally or in RStudio Cloud: https://sites.google.com/a/utexas.edu/edm-principalstratification/downloading-installing-r-jags-rstudio
#pkgTest("tidyverse")
pkgTest("knitr")
pkgTest("kableExtra")
pkgTest("stringr")
pkgTest("coda")
pkgTest("tidybayes")
pkgTest("gridExtra")
pkgTest("grid")
pkgTest("R2jags") 
pkgTest("readr")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("lubridate")
pkgTest("tidyr")
pkgTest("tibble")
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
ggplot2::theme_set(new = theme_bw())
library(tidyverse)
library(knitr)
library(kableExtra)
library(stringr)
library(coda)
library(tidybayes)
library(gridExtra)
library(grid)
library(R2jags)
library(readr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(tibble)
```

```{r }
load("Leaders.Rdata")
leaders <- as.data.frame(leaders)
#head(leaders)
prev_date <- as.Date("31/07/2020",format="%d/%m/%Y")
current_date <- as.Date("31/08/2020",format="%d/%m/%Y")

## remove days string and convert to numeric
leaders <- leaders %>% 
  mutate(Age.Event = sub(".*?(\\d+\\.*\\d*).*", "\\1", Age.Event)) %>% data.frame
leaders$Age.Event <- as.numeric(leaders$Age.Event)

## update age event by adding 1/12 to leaders still alive (none died in past month so easy to do case when)
leaders <- leaders %>% 
  mutate(Age.Event = case_when(Event.Date == prev_date ~ Age.Event + 1/12,
                               TRUE ~ Age.Event)) %>% data.frame

## update event dates to be current day since none of the leaders in this set died in the past month
leaders <- leaders %>% 
  mutate(Event.Date = case_when(Event.Date == prev_date ~ as.Date(current_date,format="%d/%m/%Y"),
                                TRUE ~ Event.Date)) %>% data.frame

## update Emperor Jianwen
leaders <- leaders %>% 
  mutate(Fail = case_when(Name == "Jianwen Emperor" ~ 1,
                          TRUE ~ Fail),
         Censored = case_when(Name == "Jianwen Emperor" ~ 0,
                              TRUE ~ Censored)) %>% data.frame

## multiplying time by 10 
leaders <- leaders %>% 
  mutate(decade = time * 10)
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
filtered_leaders = leaders %>% 
  filter(!Name %in% alive)

#load("leaders_model_r_25_2e-1_beta_1.Rdata")
#Bayesian_Leaders_output <- rjags_model
```

```{r}
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
filtered_leaders = leaders %>% 
  filter(!Name %in% alive)

n <- nrow(filtered_leaders)
Age.Event <- filtered_leaders$Age.Event
censored <- filtered_leaders$Censored
survival <- ifelse(censored == 0, Age.Event, NA)
censoring_limits <- ifelse(censored == 0, 100, Age.Event)

# Co-variates
x_1 <- filtered_leaders$time - mean(filtered_leaders$time)
x_2 <- filtered_leaders$Type %>% as.factor() %>% relevel("Pope")
```

```{r}
# predictive info for Francis, Obama, and Naruhito
# 1 = Pope, 2 = ChineseEmp, 3 = DalaiLama, 4 = JapanEmp, 5 = UsPres
#Dalai Lama
time_DL <- 6.3549350 - mean(filtered_leaders$time)
type_DL <- 3
present_age_DL <- 85.153833

#Francis
time_Francis <- 6.3694456 - mean(filtered_leaders$time)
type_Francis <- 0
present_age_Francis <- 83.702772

#Obama
time_Obama <- 6.6157426 - mean(filtered_leaders$time)
type_Obama <- 5
present_age_Obama <- 59.073066

#Naruhito
time_Naruhito <- 6.6012868 - mean(filtered_leaders$time)
type_Naruhito <- 4
present_age_Naruhito <- 60.518652

present_age <- ifelse(censored == 0, 0, filtered_leaders$Age.Event)
upper_age <- 110
```

```{r}
data_leaders <- list("n",
                     "censored",
                     "survival",
                     "censoring_limits",
                     "x_1",
                     "x_2", 
                     "present_age",
                     "upper_age",
                     "time_Francis",
                     "present_age_Francis",
                     "time_Obama",
                     "type_Obama",
                     "present_age_Obama",
                     "time_DL",
                     "type_DL",
                     "present_age_DL",
                     "time_Naruhito",
                     "type_Naruhito",
                     "present_age_Naruhito")
```

```{r}
generate_model_text = function(priors=""){
  model_file <- tempfile()
  
  likelihood = "#Likelihood
  for (i in 1:n){ 
    censored[i] ~ dinterval(survival[i], censoring_limits[i]) 
    survival[i] ~ dweib(r, mu[i]) # Basic Weibull assumption
    mu[i] <- exp(beta[i])  # Defining beta as log(mu)
    beta[i] <- beta_0 + beta_1*x_1[i] + beta_type[x_2[i]] + beta_int[x_2[i]] * x_1[i] 
    y_pred_censored[i] ~ dweib(r, mu[i])T(present_age[i], upper_age)
  }
    
  #Priors
  beta_type[1] <- 0
  beta_int[1] <- 0
  "
  
  predicted_survivals = "
  #Define the alphas
  alpha_0 <- - beta_0 / r
  alpha_1 <- - beta_1 / r
  percentage_increase_birthyr <- 100*(exp(alpha_1) - 1)
  for (i in 2:5) {
    alpha_type[i] <- - beta_type[i] / r
    alpha_int[i] <- -beta_int[i] / r
    percentage_increase_type[i] <- 100*(exp(alpha_type[i]) - 1)
    percentage_increase_int[i] <- 100*(exp(alpha_int[i]) - 1)
  }
  
  beta_Francis <- beta_0 + beta_1*time_Francis 
  mu_Francis <- exp(beta_Francis)
  survival_Francis ~ dweib(r, mu_Francis)T(present_age_Francis, upper_age)
  
  beta_Obama <- beta_0 + beta_1*time_Obama + 
    beta_type[type_Obama] + beta_int[type_Obama]*time_Obama
  mu_Obama <- exp(beta_Obama)
  survival_Obama ~ dweib(r, mu_Obama)T(present_age_Obama, upper_age)
  
  beta_Naruhito <- beta_0 + beta_1*time_Naruhito + beta_type[type_Naruhito] +
    beta_int[type_Naruhito]*time_Naruhito
  mu_Naruhito <- exp(beta_Naruhito)
  survival_Naruhito ~ dweib(r, mu_Naruhito)T(present_age_Naruhito, upper_age)
  
  beta_DL <- beta_0 + beta_1*time_DL + beta_type[type_DL] + beta_int[type_DL]*time_DL
  mu_DL <- exp(beta_DL)
  survival_DL ~ dweib(r, mu_DL)T(present_age_DL, upper_age)
  "
  
  model_text <- paste("model{ ",likelihood, priors, predicted_survivals, "}")
  writeLines(model_text,con=model_file)
  return(model_file)
}
```

```{r}
generate_model = function(priors,model_name,num_iter = 250000){
  model_file <- generate_model_text(priors)
  if (file.exists(model_name)) {
    load(file = model_name)
  } 
  else {
    rjags_model <-  jags.parallel(data = data_leaders,  
                        parameters.to.save = c("beta_0",
                                               "beta_1",
                                               "beta_type",
                                               "beta_int",
                                               "r",
                                               "y_pred_censored",
                                               "survival_Francis",
                                               "survival_Obama",
                                               "survival_Naruhito",
                                               "survival_DL",
                                               "alpha_0",
                                               "alpha_1",
                                               "percentage_increase_birthyr",
                                               "alpha_type",
                                               "alpha_int",
                                               "percentage_increase_type",
                                               "percentage_increase_int",
                                               "survival"
                        ), 
                        n.iter = num_iter, #increase for better model output - 250K
                        n.chains = 3,
                        model.file = model_file)
    save(rjags_model, file = model_name)
  }
  return(rjags_model)
}
```

```{r}
## Model From Paper, Original Id: 5a
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dgamma(10,0.5) # Prior on r 
  "
Bayesian_Leaders_output <- generate_model(priors,"leaders_model_r_10_5e-1_beta_1.Rdata",500000)
```


```{r}
## Model 1a: r ~ exp(0.001), Betas ~ N(0,1)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, 1) # Prior on beta_1 is normal with low precision
  
  r ~ dexp(0.001) # Prior on r
  "
Bayesian_Leaders_V1a <- generate_model(priors,"leaders_model_r_1e-3_beta_1.Rdata")
```

```{r}
## Model 1b: r ~ exp(0.001), Betas ~ N(0,100)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, .01)
    beta_int[i] ~ dnorm(0.0, .01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, .01) # Prior on beta_1 is normal with low precision
  
  r ~ dexp(0.001) # Prior on r
  "
Bayesian_Leaders_V1b <- generate_model(priors,"leaders_model_r_1e-3_beta_100.Rdata")
```

```{r}
## Model 2a - r ~ exp(0.1), Betas ~ N(0,1)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(0.1) # Prior on r
  "
Bayesian_Leaders_V2a <- generate_model(priors,"leaders_model_r_1e-1_beta_1.Rdata")
```

```{r}
## Model 2b - r ~ exp(0.1), Betas ~ N(0,100)

priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, .01)
    beta_int[i] ~ dnorm(0.0, .01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, .01)
  
  r ~ dexp(0.1) # Prior on r
  "
Bayesian_Leaders_V2b <- generate_model(priors,"leaders_model_r_1e-1_beta_100.Rdata")
```

```{r}
## Model 3a - r ~ exp(1), Betas ~ N(0,1)

priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(1) # Prior on r
  "
Bayesian_Leaders_V3a <- generate_model(priors,"leaders_model_r_1_beta_1.Rdata")
```

```{r}
## Model 3b - r ~ exp(1), Betas ~ N(0,100)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 100)
    beta_int[i] ~ dnorm(0.0, 100)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, .01)
  
  r ~ dexp(1) # Prior on r
  "
Bayesian_Leaders_V3b <- generate_model(priors,"leaders_model_r_1_beta_100.Rdata")
```

```{r}
## Model 4a - r ~ exp(2), Betas ~ N(0,1)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(2) # Prior on r
  "
Bayesian_Leaders_V4a <- generate_model(priors,"leaders_model_r_2_beta_1.Rdata")
```



```{r}
## Model 4b - r ~ exp(2), Betas ~ N(0,100)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)
  
  r ~ dexp(2) # Prior on r
  "
Bayesian_Leaders_V4b <- generate_model(priors,"leaders_model_r_2_beta_100.Rdata")
```


```{r}
## Model 5b - r ~ gamma(10,0.5), Betas ~ N(0,100)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)
  
  r ~ dgamma(10,0.5) # Prior on r
  "
Bayesian_Leaders_V5b <- generate_model(priors,"leaders_model_r_10_5e-1_beta_100.Rdata")
```

```{r}
## Model 6a - r ~ gamma(25,0.2), Betas ~ N(0,1)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dgamma(25,0.2) # Prior on r
  "
Bayesian_Leaders_V6a <- generate_model(priors,"leaders_model_r_25_2e-1_beta_1.Rdata")
```

```{r}
## Model 6b - r=gamma(25,0.2), Betas: N(0,100)
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }

  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)

  r ~ dgamma(25,0.2) # Prior on r
  "
Bayesian_Leaders_V6b <- generate_model(priors,"leaders_model_r_25_2e-1_beta_100.Rdata")
```

# Introduction 

World leaders have measurable influence in politics, even beyond their election terms. For this reason, it is critical to explore their lifespans. Extending the investigation from Stander et al.[[1]][Bibliography], we analyze the survival times of 177 world leaders, including Roman Catholic Popes, U.S. Presidents, Chinese and Japanese Emperors, and Dalai Lamas. We propose a Weibull distribution for modeling the survival time of these world leaders and provide a mechanism for predicting their survival times within a Bayesian framework. 

Our goal is to ultimately determine how year of birth and type of leadership are related to a leader's survival time. Furthermore, we seek to understand if the relationship between year of birth and lifespan is dependent on type of leadership. Finally, we provide point and interval predictions of the lifespans of living leaders, along with posterior predictive distributions to make comparative statements about future survival times. 

# Data 

Leaders in this dataset date from the 14th century through present day. Survival time, in years, is defined to be either the leader’s current age, if alive, or age of death, if deceased. The 10 leaders in the dataset that are currently alive are considered right censored observations - that is, we do not know their age of death, but know their current age. 

Covariates of interest in this study are $type$ and $time$. $Type$ is a categorical variable corresponding to 5 different groups of world leaders. Of the $type$ levels, popes are the most represented with 63 observations while Dalai Lamas comprise the smallest group, with only 14 instances. The $time$ covariate represents a leader's year of birth, measured as the number of centuries since 1300. For example, as Pope Francis was born roughly 637 years after January 1, 1300, his $time$ value is represented as 6.37. We opted for this shifted and scaled version of birth year in order to prevent larger year values (1961, for example) from causing model instability. 

Below we will present some preliminary visualizations regarding our covariates of interest and survival outcome. In these visualizations, we use the term *transformed birth year* to refer to the $time$ covariate, in order to provide a more intuitive interpretation.

```{r eval=FALSE}
ggplot(leaders, aes(x=Age.Event)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Lifespan") + xlab("Lifespan (yrs)") + geom_vline(xintercept = median(leaders$Age.Event), color = "red") + annotate(geom = "text", x = 83, y = 45, label = "median: 67.5")
```

## Exploratory Data Analysis 

```{r fig.align='center', fig.width=12}
gridExtra::grid.arrange(ggplot(leaders, aes(x = Type, y = Age.Event)) + 
                          geom_boxplot() + 
                          labs(title = "Lifespans vs Type of Leader", 
                               y="Lifespan (yrs)", x="Leader Type",
                               caption="Figure 1") + 
                          theme(
                            plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 18))
                        ,
                        ggplot(leaders, aes(x=time, y=Age.Event, shape=Type, color=Type)) +
                          geom_point() + 
                          labs(title="Lifespans vs Transformed Birth Year",
                               caption="Figure 2") + 
                          xlab("Transformed Birth Year") +
                          geom_smooth(method = "lm", se=FALSE) + 
                          theme(axis.title.y = element_blank(),
                                plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 18)),
                        ncol=2)

```

Figure 1 displays lifespan across different leadership types. Among the Chinese Emperors, Japanese Emperors, and Dalai Lamas, the interquartile ranges of lifespan largely overlap. Popes and U.S. presidents appear to have a slightly higher median lifespan relative to these three groups. This is consistent with the fact that Popes and Presidents are elected much later in their lives, while Chinese Emperors, Japenese Emperors, and Dalai Lamas typically come to power when they are younger (whether due to heredity or identification at a young age). An American citizen who dies in her youth, for example, can never become President due to the age threshold delineated in the Constitution. Consequently, her short survival time can never be reflected in this dataset. 


Figure 2 displays the change in lifespan across time for different types of leadership. It appears that lifespan has increased at similar rates across Chinese and Japanese Emperors, U.S. Presidents and Popes over time. However, for Dalai Lamas, the plot indicates that lifespan has decreased over time. This unexpected trend can be attributed to the untimely demise of several Dalai Lamas in the 19th century, with causes of death ranging from common illnesses to ceiling collapses [[5]][Bibliography]. 

# Methodology

## Model Selection 

We propose a Weibull distribution to model the survival time $T_i$ for the $i$th leader. This distribution is a generalization of the exponential distribution and can be used to model survival outcomes. The Weibull probability density function for $T_i$ takes the following form:

$$
f_{T_i}(t_i|r, \mu_i) = r\ \mu_i\ t_i^{r-1}\ exp(-\mu_i\ {t_i}^r),\ \ \ \ \ r,\  \mu_i, \ t_i >0
$$

The first parameter $r$ of the Weibull distribution is a positive scale parameter, and is constant across all leaders. The log of the second parameter, $\mu_i$, is a linear function of $time$, $type$, and the interaction effect between the previous two covariates. For ease of interpretability, $time$ was mean-centered.

Our proposed model is as follows: 

$$
\begin{aligned}
T_i \sim & \,Weibull(r, \mu_i)  \\
log(\mu_i) = \beta_0 + \beta_1\ time_i + \sum_{j=2}^{5} \beta_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \beta_{3j}\ time_i * I(type_i = j)\ , &(1)
\end{aligned}
$$

In Model 1.1, $i$ corresponds to each world leader and $T_i$ refers to their survival time. The $time_i$ covariate represents birth year, measured in the number of centuries after 1300 that each leader was born, and $type_i$ refers to the individual's type of leadership. The reference level for the $type$ covariate is Pope, as it forms the largest category ($n=63$). The remaining levels $j = 2, 3, 4, 5$ correspond to Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President respectively. The third term in the linear combination of covariates represents an interaction effect between $type$ and $time$. This interaction is used to account for the varying relationships between survival time and birth year that may exist across leadership types. 

To account for censored observations, we sample $T_i$ from a truncated distribution

$$
T_i \sim  \,Weibull(r,\, \mu_i)\,T(present\_age_i, \, upper\_age)
$$

Here, $present\_age_i$ is 0 for a leader who is deceased, and their current age if they are still alive. For deceased leaders, the lower bound of 0 prevents the model from making assumptions about their lifespan. For leaders who are currently alive, it ensures the model does not sample a survival time that is less than their current age. We set the $upper\_age$ to be 110. We selected this upper bound due to the fact that the United Nations predicts that only 0.0074% of the world's population will celebrate their 100th birthday and become a centenarian [[2]][Bibliography]. Of this small percentage of people, the Gerontology Research Group estimates only 0.15% to 0.25% will reach the age of 110 [[3]][Bibliography]. 

## Choice of Prior Distributions

We adopted the following prior distributions for $r,\ \beta_0, \  \beta_1,\  \beta_{2j}$ and $\beta_{3j}$:

$$
\begin{aligned}
&r \sim  \Gamma(10, 0.5)\\ 
&\beta_0\ \sim N(0,100)\\
\beta_1,\ &\beta_{2j},\ \beta_{3j} \sim N(0, 1), \ \ \ \  j = 2, 3, 4, 5
\end{aligned}
$$

Though there does not exist a strong body of literature to inform these priors, each of our choices resulted from research and consideration of context. For the prior on $\beta_1$, the coefficient corresponding to the $time$ covariate, we decided to use a $N(0, 1)$ distribution. We were motivated to explore this zero-centered, low variance prior due to a study [[4]][Bibliography] citing that lifespan has not significantly changed over the past centuries. Thus, this prior reflects our beliefs that birth year does not heavily impact survival time. For the priors on $\beta_{2j}$, which are coefficients for each of the 4 levels of $type$ (Chinese Emperor, Dalai Lama, Japanese Emperor, and U.S. President), we observed that each leader type is tied to a region. Our research on lifespans across these various regions [[2]][Bibliography] indicates that they are roughly comprable, so we chose a $N(0,1)$ prior for each $\beta_{2j}$. Similarly, we chose a $N(0,1)$ prior for the interaction coefficients $\beta_{3j}$. Here, we did not have a strong enough belief that the coefficients were non-zero and thus chose the same priors as before. For our prior on $\beta_0$, the intercept term, we chose a noninformative $N(0,100)$. This intercept term is tricky to interpret given this parameterization of the Weibull distribution. For this reason, it was safest to impose an high variance prior with mean 0. 

Our prior on $r$ was informed by the context of the study. Values of $r$ between 0 and 1 indicate a decreasing rate of failure over time, while those greater than 1 represent an increasing rate of failure. Because it can be assumed that the rate of death for world leaders increases with age, we want an $r$ value greater than 1. This belief warranted an informative $\Gamma(10, 0.5)$ prior with mean 5 and variance 2.5, reflecting a relative degree of certainty that $r$ takes on value greater than 1. We perform sensitivity analysis, along with other model diagnostics, in Section 4.2.2. 

# Results 

## Summary of Parameters

```{r}
post_summary_df <- Bayesian_Leaders_output$BUGSoutput$summary %>% 
  as.data.frame() 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)
post_summary_df <- post_summary_df[rows,]
post_summary_df <- post_summary_df %>% 
  tibble::rownames_to_column("Parameter") %>% 
  mutate_if(is.numeric, round, digits = 3) %>% 
  mutate("95% CI" = paste0("(", `2.5%`, ", ", `97.5%`,  ")")) %>% 
  select(-(`2.5%`:`97.5%`)) %>% 
  select(Parameter, mean, sd, `95% CI`) 
post_summary_df$Parameter <- c("r", "(Intercept)", "Time", "Pope", "ChinaEmp", "DalaiLama", "JapanEmp", "UsPres",
                               "Pope*Time", "ChinaEmp*Time", "DalaiLama*Time", "JapanEmp*Time", "UsPres*Time")

post_summary_df %>% 
  mutate(mean = ifelse((mean == 0 & sd == 0), "(Reference)", mean),
         sd = ifelse((mean == "(Reference)" & sd == 0),"", sd),
         `95% CI` = ifelse((mean == "(Reference)" & sd == ""), "", `95% CI`)#,
         #Rhat = ifelse((mean == "(Reference)" & sd == ""), "", Rhat)
  ) %>% 
  kableExtra::kable(booktabs = T, 
                    caption = "Parameters obtained with Model 1.1, with 95\\% Credible Intervals (CI)",
                    col.names = c("Parameter", "Mean", "Std. Dev.", "95% CI"#, "Rhat"
                    )) %>% 
  kable_styling(latex_options = c("hold_position")) %>% 
  kableExtra::pack_rows("Type", 4,8) %>% 
  kableExtra::pack_rows("Type*Time", 9,13) %>% 
  row_spec(0, bold = TRUE)
```

Using JAGS, we ran Model 1 with 250,000 simulations to determine the posterior density $\pi(r, \ \beta_0, \ \beta_1, \ \beta_{2j}, \ \beta_{3j}\, | \,data)$, with results summarized in Table 1. The 95% credible interval is created using the 2.5%  and 97.5% quantiles from the posterior distribution. 

## Model Diagnostics 

### Convergence & Autocorrelation Checks 

```{r eval=FALSE}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_1) %>% 
  ungroup() %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta[1])), 
       x = "Iteration", y = "Value",  color = "Chain") 

```

```{r eval=FALSE}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_type[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["2j"], " (coefficients for Type)")), 
       x = "Iteration", y = "Value",  color = "Chain")
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_int[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["3j"], " (coefficients for Type * Time)")), 
       x = "Iteration", y = "Value",  color = "Chain", caption="Figure 3") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12))
# plot_acf <- function(parameter) {
#   Bayesian_Leaders_output$BUGSoutput$sims.matrix %>% 
#     as_tibble() %>% 
#     pull(parameter) %>% 
#     acf(main = paste0("Lag-1 Autocorrelation for ", parameter))
# }
# for (param in c("r","beta_0", "beta_1",
#                 "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]", 
#                 "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]")) {
#   plot_acf(param)
# }
```

To determine if our model has converged sufficiently, we first examine traceplots for each of the parameters. Traceplots with random scatter around a mean value indicates that the model has converged. $\hat{R}$ values provide an estimate of convergence based on the variance of an estimated parameter between chains, and the variance wtihin a chain. The closer the $\hat{R}$ value to 1, the better the model has converged. Traceplots show the chains have mixed well and the $\hat{R}$ values are all below 1.05, indicating that our model has sufficiently converged. 

To determine if our model has reached a stationary distribution, we first looked at autocorrelation plots. The lag-1 autocorrelation plots peak at the beginning and then bounce around 0. In addition, $n_{eff}$ gives a measure of effective sample size. Ideally, we want this number to equal the number of posterior draws, or at least 200. The autocorrelation plots and large $n_{eff}$ values indicate that our parameters have sufficiently reached stationarity.

The traceplots, lag-1 autocorrelation plots, as well as the $\hat{R}$ and $n_{eff}$ values, can be found in the Appendix. 


### Sensitivity Analysis 

```{r fig.width=12, fig.align='center'}
r_vals <- c("1e-3", "1", "10_5e-1", "25_2e-1")
b_vals <- c("1", "100")
sensitivity_plot = function(param, renamed_param = NA) {
  df = data.frame()
  for (curr_r in r_vals) {
    for (curr_b in b_vals) {
      file_name = paste0("leaders_model_r_",curr_r,"_beta_",curr_b,".Rdata")
      load(file_name)
      
      curr_param = param
      rjags.df <- rjags_model$BUGSoutput$sims.matrix %>% as.data.frame()
      if (!is.na(renamed_param)){
        colnames(rjags.df)[colnames(rjags.df) == param] = renamed_param
        curr_param = renamed_param
      }
      
      param_df = rjags.df %>%
        select(curr_param) %>% 
        mutate(curr_r = case_when(
          curr_r == "1e-3" ~ "0.001",
          curr_r == "10_5e-1" ~ "10_0.5",
          curr_r == "25_2e-1" ~ "25_0.2",
          TRUE ~ as.character(curr_r)),
          priors = ifelse(str_detect(curr_r, "_"),
                          paste0("r~Ga(", str_split(curr_r, "_")[[1]][1], ",", str_split(curr_r, "_")[[1]][2], "),B~N(0,", curr_b, ")"),
                          
                          paste0("r~Exp(", curr_r, "),B~N(0,", curr_b, ")")
          ))
      df = df %>% bind_rows(param_df)
    }
  }
  return(df) 
}
#Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(mean)
mean_vals <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(mean)
predicted_beta_1 <- c(mean_vals["beta_1",])

sensitivity_plot("beta_1")  %>% 
  ggplot() + 
  geom_density(aes(x = beta_1)) + geom_vline(xintercept = predicted_beta_1, color = "red") + 
  labs(title = expression(paste("Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 3") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 

``` 

In Figure 3, we explore the posterior distributions of $\beta_1$ resulting from various priors, where the red line indicates our posterior mean estimate of $\beta_1$. The posterior distributions are roughly the same for the four different $r$ priors, each paired with two different priors on the $\beta$ coefficients. This indicates that the results of our model are not sensitive to prior choices. 

### Standardized Residual Plots 

```{r}
modelOutput <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame()
survivalPredicted <- modelOutput[211:383, ] %>% select("mean", "sd", "2.5%", "50%", "97.5%")
#creating dataframe with useful information (including prediction residuals and standardized residuals)
leader <- filtered_leaders$Name
censored_value <- as.factor(filtered_leaders$Censored)
actual_survival <- filtered_leaders$Age.Event
time <- filtered_leaders$time
survivalPredicted <- survivalPredicted %>%
  mutate(actual = actual_survival) %>%
  mutate(name = leader) %>%
  mutate(Censored = censored_value) %>%
  mutate(Standardized_Residual = (actual-mean)/sd) %>%
  mutate(Residual = actual-mean) %>%
  mutate(time_of_birth = time)
```

```{r fig.height=3.75, fig.align='center'}
# #standardized residual plot
# shapes = c(16, 4) 
# shapes <- shapes[as.numeric(survivalPredicted$Censored)]
# plot(y = survivalPredicted$Standardized_Residual, x = survivalPredicted$time_of_birth, col= survivalPredicted$Censored, pch = shapes, main = "Standardized Residuals vs Time", xlab = "Time", ylab = "Standardized Residuals")
# abline(h =0)
# legend("topleft", legend = c("Non-Censored", "Censored"),
#        col =  c("black", "red"),
#        pch = c(16, 4), cex = 0.75)

ggplot(data = survivalPredicted %>% mutate(Censored = case_when(
  Censored == 1 ~ "Censored",
  TRUE ~ "Non-Censored"
)), aes(x = time_of_birth, y = Standardized_Residual, color = Censored)) + 
  geom_point(alpha = 0.8) + 
  labs(title = "Standardized Residuals vs Time",
       x = "Time", y = "Standardized Residuals", caption = "Figure 4",
       color = "") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 12)) + 
  scale_shape_manual(values = c(2,4)) +
  scale_colour_manual(values = c("red", "black")) + 
  scale_fill_manual(name = "", labels = c("Non-Censored", "Censored")) 

```

We also examined the standardized residuals, defined as $std\_r_i = (T_i - E[T_i])/sd[T_i]$, and plot $std\_r_i$ against $time_i$ in Figure 4. The plot shows that the standardized residuals are generally randomly dispersed about 0, where the censored observations are marked by a red dot. As expected, we have large negative standardized residuals for the censored observations because their current ages are lower than their mean predicted ages. 

# Discussion 

## Interpretation of Parameters 

Our model for survival time can be reparameterized in such a way that eases interpretability. Specifically, the log mean of $T_i$ can be written as a linear function of our covariates of interest: 

$$
\begin{aligned}
log(mean[T_i]) =  \alpha_0 + \alpha_1\ time_i + \sum_{j=2}^{5} \alpha_{2j} & \ I(type_i = j) + \sum_{j=2}^{5}  \alpha_{3j}\  I(type_i = j)\ *time_i
\end{aligned}
$$

where $\alpha_k = - \frac{\beta_k}{r}$ for any $k$. When exponentiating both sides of this expression, we observe that an increase in one unit of $time$ results in a multiplicative change of $exp(\alpha_1)$ in the mean survival time for a Pope. We can further compute the *percentage* increase in the mean survival time of a Pope given a unit increase in $time$ by computing $100 * (exp(\alpha_1) − 1)$. A similar computation can be performed to understand the effect of increasing time on mean survival time across leader types. This provides an interpretable quantification of the interaction term, $type*time$ appearing in the expression for $log(\mu)$.


```{r}
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()

#Pope
pope_alpha <- c(model$`2.5%`[2], model$mean[2], model$`97.5%`[2])
pope_multiplicative_difference <- exp(0.1*pope_alpha)
pope_percent_difference <- 100*(pope_multiplicative_difference - 1)


#Chinese Emperors
ce_alpha <- c(model$`2.5%`[2] + model$`2.5%`[3], model$mean[2] + model$mean[3], model$`97.5%`[2] + model$`97.5%`[3])
ce_multiplicative_difference <- exp(0.1*ce_alpha)
ce_percent_difference <- 100*(ce_multiplicative_difference - 1)

#Dalai Lama
dl_alpha <- c(model$`2.5%`[2] + model$`2.5%`[4], model$mean[2] + model$mean[4], model$`97.5%`[2] + model$`97.5%`[4])
dl_multiplicative_difference <- exp(0.1*dl_alpha)
dl_percent_difference <- 100*(dl_multiplicative_difference - 1)

#Japanese Emperor

je_alpha <- c(model$`2.5%`[2] + model$`2.5%`[5], model$mean[2] + model$mean[5], model$`97.5%`[2] + model$`97.5%`[5])
je_multiplicative_difference <- exp(0.1*je_alpha)
je_percent_difference <- 100*(je_multiplicative_difference - 1)

#US Presidents

us_alpha <- c(model$`2.5%`[2] + model$`2.5%`[6], model$mean[2] + model$mean[6], model$`97.5%`[2] + model$`97.5%`[6])
us_multiplicative_difference <- exp(0.1*us_alpha)
us_percent_difference <- 100*(us_multiplicative_difference - 1)


Type <- c("Pope", "Chinese Emperor", "Dalai Lama", "Japanese Emperor", "U.S. President")
Multiplicative_Scale_Factor <- data.frame(Type, t(data.frame(pope_multiplicative_difference, ce_multiplicative_difference, dl_multiplicative_difference, je_multiplicative_difference, us_multiplicative_difference))) 
Percent_Difference <- data.frame(Type, t(data.frame(pope_percent_difference, ce_percent_difference, dl_percent_difference, je_percent_difference, us_percent_difference)))

bind_rows(Multiplicative_Scale_Factor,
          Percent_Difference) %>% 
  tibble::rownames_to_column() %>% 
  mutate_if(is.numeric, round, digits=3) %>% 
  mutate(Mean = X2, 
         `95% CI` = paste0("(", X1, ", ", X3, ")")) %>% 
  select(-(X1:X3), -rowname) %>% 
  kableExtra::kable(booktabs = TRUE,
                    caption = "Multiplicative and Percent Change in Mean Survival Time, from decade increase in Birth Year", 
                    col.names = c("Leadership Type", "Mean", "95% CI")) %>% 
  kable_styling(latex_options = c("hold_position")) %>% 
  kableExtra::pack_rows("Multiplicative Difference", 1,5) %>% 
  kableExtra::pack_rows("Percent Difference", 6,10) %>% 
  row_spec(0, bold = TRUE) %>% 
  column_spec(column = c(2:3), latex_column_spec = "c") %>% 
  column_spec(column = c(1), width = "20em")

model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()

#Chinese Emperors
ce_int <- exp(model$mean[7])

#Dalai Lamas
dl_int <- exp(model$mean[8])

#Japanese Emperor
je_int <- exp(model$mean[9])

#US Pres
us_int <- exp(model$mean[10])
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()
#Chinese Emperors
ce_int <- exp(model$mean[7])
#Dalai Lamas
dl_int <- exp(model$mean[8])
#Japanese Emperor
je_int <- exp(model$mean[9])
#US Pres
us_int <- exp(model$mean[10])
```

In Table 2, we summarize the multiplicative and percent changes in the mean survival time resulting from a decade increase in birth year for each leader type. Recall that $time$ is a scaled and shifted version of birth year that is measured in centuries. We thus consider the changes resulting from a 0.1 unit increase in $time$ in order to make interprations on a decade scale. These values indicate that, barring the Dalai Lamas, as a leader's birth year increases by a decade, their expected survival time increases as well. For U.S. Presidents, a decade increase in birth year results in a `r round(us_percent_difference[2], digits = 2)` expected percentage increase in surival time- the highest across groups. For Popes, Chinese Emperors, and Japanese Emperors, the expected increases are slightly more modest, hovering around 0.3%. In contrast, the expect survival time change for a decade increase in birth year for Dalai Lamas is `r round(dl_percent_difference[2], digits = 2)`. This negative prediction is consistent with the string of successive early deaths among these leaders that occurred in the 19th century.


In this sense, the relationship between birth year and survival time is somewhat dependent on leadership type. As Chinese Emperors, Japanese Emperors, and Popes exhibit very similar increases in expected survival, it seems that their respective leadership types do not play a strong role in determining the relationship between birth year and survival. However, when considering U.S. Presidents and Dalai Lamas, we see that the effect of birth year on survival is strongly influenced by type of leadership.

Interpreting the individual effect of $type$ on survival time is not as straightforward as understanding its interaction with $time$. However, if we choose certain values of $time$ to condition on, we can extract meaningful insights. Consider leaders with a birth year corresponding to the mean $time$ value in the dataset, which is 1674. For these leaders, we can quantify the multiplicative change that occurs in mean survival time in relation to the baseline level of popes. 

Let $pope_i$ represent a Pope born in the mean birth year of the dataset. Then, a Chinese Emperor with the same birth year has an expected predicted survival time that is `r round(ce_int, 2)` times as much as $pope_i$. Similarly, a Dalai Lama born in the same year will be expected to survive only `r round(dl_int, 2)` times as long as $pope_i$. For a Japanese emperor of mean birth year, expected survival time is `r round(je_int, 2)` times that of $pope_i$. And finally, a U.S. President has an expected survival time that is `r round(us_int, 2)` times as much of $pope_i$. Calculations for these values are included in the Appendix. These values indicate that, among all leaders with the mean birth year of the dataset, popes have the largest mean survival time. However, this statement does not generalize across birth year.

## Posterior Predictive Distribution 

```{r}
alive_leaders = leaders %>% 
  filter(Name %in% alive) %>% 
  bind_rows(filtered_leaders %>% 
              mutate(rownum = row_number()) %>% 
              filter(Censored == 1))

al_index = alive_leaders %>% 
  filter(!is.na(rownum)) %>% 
  pull(rownum) %>% 
  paste0("y_pred_censored[", ., "]") %>% 
  as.vector()

al_names = alive_leaders %>% pull(Name) %>% str_remove_all("\\s*\\([^\\)]+\\)")
al_cur_age = alive_leaders %>% pull(Age.Event)
al_type = alive_leaders %>% pull(Type)
alive_leaders_post = Bayesian_Leaders_output$BUGSoutput$summary[c("survival_Francis",
                                             "survival_Obama",
                                             "survival_DL",
                                             "survival_Naruhito",
                                             al_index), ] %>%
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  mutate(rowname = al_names,
         cur_age = al_cur_age,
         type = al_type
         # ,
         # type = case_when(
         #   type == "DalaiLama" ~ "Dalai Lama", 
         #   type == "JapanEmp" ~ "Japanese Emperor", 
         #   type == "UsPres" ~  "US President", 
         #   TRUE ~ as.character(type))
  ) %>% 
  mutate_if(is.numeric, round, digits=3) 

alive_leaders_post %>% 
  mutate("95% CI" = paste0("(", `2.5%`,", ", `97.5%`, ")")) %>% 
  select(rowname, type,  cur_age, mean, `50%`, sd, "95% CI") %>% 
  kableExtra::kbl(booktabs = TRUE, caption = "Posterior Predictions for Lifespans of Living Leaders, with 95\\% Credible Intervals (CI)", 
                  col.names = c("Leader", "Type", "Current Age", "Mean", "Median", "Std. Dev.", "95% CI")) %>% 
  kable_styling(position = "center",latex_options = c("hold_position")) %>% 
  row_spec(0, bold = TRUE) %>% 
  column_spec(column = c(3:7), latex_column_spec = "c") %>% 
  #kable_styling(position = "center", latex_options = c("hold_position")) %>% 
  add_header_above(c(" " = 3, "Posterior Values" = 4))  
```

Now we will address the research objective of providing posterior predictions of the lifespans of living leaders. Table 3 displays these point and interval predictions. Since we set the upper bound of the truncated Weibull distribution to 110 years, we expect the upper tails of the 95% credible intervals to be near 110 years. This is the case for all the leaders except the 14th Dalai Lama, whose 97.5% quantile is `r alive_leaders_post %>% filter(rowname == "14th Dalai Lama") %>% pull("97.5%")` years. As previously discussed, there was a string of early deaths among Dalai Lamas in the 19th century, which may have impacted the posterior predictions for the 14th Dalai Lama. Furthermore, Dalai Lamas represent the smallest group of leadership type ($n = 14$), which limits these predictions. 

## Applications for Select Leaders 

```{r eval=FALSE}
# probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis
# 
# 
# ggplot(DL_vs_francis_data, aes(x = DL_vs_francis, y = ..density..)) + 
#   geom_histogram(binwidth = 4) + 
#   labs(x = "Difference in Life Expectancy (Dalai Lama - Francis)",
#        y = "Predictive Probability Density", 
#        title = "Distribution of Difference in Predicted Life Expectancy", 
#        subtitle = "Dalai Lama and Pope Francis") + 
#   theme_light() + 
#   geom_vline(xintercept=mean(DL_vs_francis), color = "blue")
```


```{r fig.align='center', fig.width=12}
#probability that Obama will live longer thatn Naruhito
survival_DL <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_DL"]
survival_Francis <-Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Francis"]

DL_vs_francis <- survival_DL - survival_Francis
DL_vs_francis_data <- as.data.frame(DL_vs_francis)
survival_Obama <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Obama"]
survival_Naruhito <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Naruhito"]

Obama_vs_naruhito <- survival_Obama - survival_Naruhito
Obama_vs_naruhito_data <- as.data.frame(Obama_vs_naruhito)





gridExtra::grid.arrange(ggplot(DL_vs_francis_data, aes(x = DL_vs_francis, y = ..density..)) + 
                          geom_histogram(binwidth = 4) + 
                          labs(x = "Difference in Life Expectancy (Dalai Lama - Francis)",
                               y = "Predictive Probability Density", 
                              
                               subtitle = "Dalai Lama and Pope Francis",
                               caption = "Figure 5") + 
                         
                          geom_vline(xintercept=mean(DL_vs_francis), color = "blue") + 
                          theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 18)),
                        ggplot(Obama_vs_naruhito_data, aes(x = Obama_vs_naruhito, y = ..density..)) + 
                          geom_histogram(binwidth = 4) + 
                          labs(
                               subtitle = "President Obama and Emperor Naruhito",
                               x = "Difference in Life Expectancy (Obama - Naruhito)", 
                               y = "Predictive Probability Density",
                               caption = "Figure 6")  +  
                        
                          geom_vline(xintercept=mean(Obama_vs_naruhito), color = "blue") + 
                          theme(axis.title.y = element_blank(),
                                plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 18)),
                        ncol = 2,top = textGrob("Distribution of Difference in Predicted Life Expectancy",gp=gpar(fontsize=20)))


```

Figures 5 and 6 show the distribution of difference in predicted life expectancy of select leaders. 

From the posterior predictive samples for the survival times of the 14th Dalai Lama and Pope Francis, we note that only in  `r round(100*mean(survival_DL>survival_Francis),1)`% of the simulated samples is the Dalai Lama predicted to have a longer lifespan. Thus, there is only a `r round(mean(survival_DL>survival_Francis),3)` probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis. Figure 5 indicates that, on average, the posterior predictions for the survival time of the 14th Dalai Lama are `r -1*round(1*mean(DL_vs_francis), 3)` years (shown by the blue line) below that of Pope Francis. 

From the posterior predictive samples for the survival times of President Obama and Emperor Naruhito, we note that in  `r round(100*mean(survival_Obama > survival_Naruhito),1)`% of the simulated samples, Obama is predicted to have a longer lifespan. Consequently, there is a `r round(mean(survival_Obama > survival_Naruhito), 3)` probability that Obama  will have a longer lifespan than Naruhito. Figure 6 indicates that, on average, the posterior predictions for the survival time of President Obama are only `r round(mean(Obama_vs_naruhito, 3))` years above that of Emperor Naruhito. 

# Conclusion & Limitations 

Our analysis supports that the relationship between birth year and survival time is dependent on certain leadership types. Specifically, U.S. Presidents exhibit an increase in mean survival time for a decade increase in birth year. In contrast, Dalai Lamas exhibit a decrease. Having answered these questions, we will now state the limitations. These include, but are not limited to, small sample size, lack of health-related covariates, underrepresentation of women, and the unavailability of studies that inform strong prior distributions. We suggest that future studies should explore the lifespans of “unconventional” leaders, who don’t necessarily hold an official position of office, along with established leaders from Latin America, Africa, and Southeast Asia.

# Appendix 

## Bibliography

1. Julian Stander, Luciana Dalla Valle & Mario Cortina-Borja (2018) A Bayesian Survival Analysis of a Historical Dataset: How Long Do Popes Live?, The American Statistician, 72:4, 368-375, DOI: 10.1080/00031305.2017.1328374
2. World Population Prospects - Population Division. (n.d.). Retrieved August 31, 2020, from https://population.un.org/wpp/Download/Standard/Population/
3. Supercentenarian Research Foundation. (n.d.). Retrieved August 31, 2020, from http://supercentenarian-research-foundation.org/TableE.aspx
4. Ruggeri, A. (2018, October 2). Do we really live longer than our ancestors? Retrieved August 31, 2020, from https://www.bbc.com/future/article/20181002-how-long-did-ancient-people-live-life-span-versus-longevity
5. DALAI LAMA- A SHORT LIVED POSITION. (n.d.). Retrieved August 31, 2020, from https://www.tripsatasia.com/newsletter-articles/dalai-lama-a-short-lived-position

## Traceplots and Autocorrelation Plots

```{r fig.height=4, fig.align='center'}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), r,  beta_0, beta_1) %>% 
  ungroup() %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ",beta[0], ", ", beta[1], ", and r")), 
       x = "Iteration", y = "Value",  color = "Chain")
```


```{r fig.height=4, fig.align='center'}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_type[i]) %>%
  ungroup() %>%
  filter(i > 1) %>%
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>%
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>%
  ggplot() +
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) +
  facet_grid(.variable~., scales = "free_y") +
  labs(title = expression(paste("Traceplots of ", beta["2j"], " (coefficients for Type)")),
       x = "Iteration", y = "Value",  color = "Chain")
```


```{r fig.height=4, fig.align='center'}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_int[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["3j"], " (coefficients for Type * Time)")), 
       x = "Iteration", y = "Value",  color = "Chain")
```


```{r fig.width=3}
plot_acf <- function(parameter) {
  Bayesian_Leaders_output$BUGSoutput$sims.matrix %>%
    as_tibble() %>%
    pull(parameter) %>%
    acf(main = paste0("Lag-1 Autocorrelation for ", parameter))
}
for (param in c("beta_0", "beta_1")) {
  plot_acf(param)
}
```

## $\hat{R}$ and $n_{eff}$

Note that $n_{eff}$ values for $\beta_{21}$ and $\beta_{31}$ are 1, because forced these parameters to be 0 to reflect the baseline category of $type$. 
```{r}
rhat_neff = Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(Rhat, `n.eff`) 
rows <- c("r", "beta_0", "beta_1", 
          "beta_type[1]", "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]",
          "beta_int[1]", "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]"
)
rhat_neff[rows,] %>% 
  tibble::rownames_to_column() %>%
  kableExtra::kbl(booktabs = TRUE, 
                  col.names = c("Parameter", "Rhat", "N_Eff"))%>% 
  kable_styling(position = "center")
```

## Further Sensitivity Analysis

```{r}
mean_vals <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame() %>% select(mean)

get_mean_val <- function(param, renamed_param=NA){
  if (!is.na(renamed_param)){
    mean_vals.df <- as.data.frame(mean_vals)
    rownames(mean_vals.df)[rownames(mean_vals.df) == param] = renamed_param
    mean_vals <- as.matrix(mean_vals.df)
    param = renamed_param
  }
  return(c(mean_vals[param,]))
}

predicted_r <- get_mean_val("r")
predicted_beta_1 <- get_mean_val("beta_1")
predicted_dl <- get_mean_val("survival_DL")
predicted_francis <- get_mean_val("survival_Francis")
predicted_naruhito <- get_mean_val("survival_Naruhito")
predicted_obama <- get_mean_val("survival_Obama")

predicted_ChinaEmp <- get_mean_val("beta_int[2]","ChinaEmp")
predicted_DalaiLama <- get_mean_val("beta_int[3]","DalaiLama")
predicted_JapanEmp <- get_mean_val("beta_int[4]","JapanEmp")
predicted_USPres <- get_mean_val("beta_int[5]","USPres")

predicted_ChinaEmpTime <- get_mean_val("beta_type[2]","ChinaEmpTime")
predicted_DalaiLamaTime <- get_mean_val("beta_type[3]","DalaiLamaTime")
predicted_JapanEmpTime <- get_mean_val("beta_type[4]","JapanEmpTime")
predicted_USPresTime <- get_mean_val("beta_type[5]","USPresTime")
```

```{r}
sensitivity_plot("r")  %>% 
  ggplot() + 
  geom_density(aes(x = r)) + geom_vline(xintercept = predicted_r, color = "red") + 
  labs(title = expression(paste("r : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 7.1") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
# sensitivity_plot("beta_1")  %>%
#   ggplot() +
#   geom_density(aes(x = beta_1)) + geom_vline(xintercept = predicted_beta_1, color = "red") +
#   labs(title = expression(paste("ime Coefficient: Sensitivity Analysis for Different Priors on r and ", beta)),
#        x = expression(beta[1]),caption="Figure 7.2") + xlim(80,90) + 
#   theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) +
#   facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
sensitivity_plot("survival_DL")  %>%
  ggplot() +
  geom_density(aes(x = survival_DL)) + geom_vline(xintercept = predicted_dl, color = "red") +
  labs(title = expression(paste("14th Dalai Lama: Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 8") + xlim(80,90) + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) +
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
sensitivity_plot("survival_Francis")  %>%
  ggplot() +
  geom_density(aes(x = survival_Francis)) + geom_vline(xintercept = predicted_francis, color = "red") +
  labs(title = expression(paste("Pope Francis: Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 9") + xlim(88,100) + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) +
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("survival_Naruhito")  %>%
  ggplot() +
  geom_density(aes(x = survival_Naruhito)) + geom_vline(xintercept = predicted_naruhito, color = "red") +
  labs(title = expression(paste("Emperor Naruhito: Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 10") + xlim(70,80) + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) +
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("survival_Obama")  %>%
  ggplot() +
  geom_density(aes(x = survival_Obama)) + geom_vline(xintercept = predicted_obama, color = "red") +
  labs(title = expression(paste("President Obama: Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 11") + xlim(80,90) + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) +
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("beta_int[2]","ChinaEmp")  %>% 
  ggplot() + 
  geom_density(aes(x = ChinaEmp)) + geom_vline(xintercept = predicted_ChinaEmp, color = "red") + 
  labs(title = expression(paste("Chinese Emperor Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 12") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("beta_int[3]","DalaiLama")  %>% 
  ggplot() + 
  geom_density(aes(x = DalaiLama)) + geom_vline(xintercept = predicted_DalaiLama, color = "red") + 
  labs(title = expression(paste("Dalai Lama Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 13") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("beta_int[4]","JapanEmp")  %>% 
  ggplot() + 
  geom_density(aes(x = JapanEmp)) + geom_vline(xintercept = predicted_JapanEmp, color = "red") + 
  labs(title = expression(paste("Japanese Emperor Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 14") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
sensitivity_plot("beta_int[5]","USPres")  %>% 
  ggplot() + 
  geom_density(aes(x = USPres)) + geom_vline(xintercept = predicted_USPres, color = "red") + 
  labs(title = expression(paste("US President * Time Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 15") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
sensitivity_plot("beta_type[2]","ChinaEmpTime")  %>% 
  ggplot() + 
  geom_density(aes(x = ChinaEmpTime)) + geom_vline(xintercept = predicted_ChinaEmpTime, color = "red") + 
  labs(title = expression(paste("Chinese Emperor * Time Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 16") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("beta_type[3]","DalaiLamaTime")  %>% 
  ggplot() + 
  geom_density(aes(x = DalaiLamaTime)) + geom_vline(xintercept = predicted_DalaiLamaTime, color = "red") + 
  labs(title = expression(paste("Dalai Lama Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 17") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2)
```

```{r}
sensitivity_plot("beta_type[4]","JapanEmpTime")  %>% 
  ggplot() + 
  geom_density(aes(x = JapanEmpTime)) + geom_vline(xintercept = predicted_JapanEmpTime, color = "red") + 
  labs(title = expression(paste("Japanese Emperor * Time Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 18") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

```{r}
sensitivity_plot("beta_type[5]","USPresTime")  %>% 
  ggplot() + 
  geom_density(aes(x = USPresTime)) + geom_vline(xintercept = predicted_USPresTime, color = "red") + 
  labs(title = expression(paste("US President * Time Coefficient : Sensitivity Analysis for Different Priors on r and ", beta)),
       x = expression(beta[1]),caption="Figure 19") + 
  theme(plot.caption = element_text(hjust = 0.5, vjust = -0.5, size = 16)) + 
  facet_wrap(priors~.,  scales = "free_y", nrow = 2) 
```

## Calculations from Section 5.1

Below, we obtain the expected multiplicative factor of being a certain leader type of mean birth year compared to being a Pope of mean birth year.

```{r echo=TRUE}
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()

#Chinese Emperors
ce_int <- exp(model$mean[7])

#Dalai Lamas
dl_int <- exp(model$mean[8])

#Japanese Emperor
je_int <- exp(model$mean[9])

#US Pres
us_int <- exp(model$mean[10])
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()
#Chinese Emperors
ce_int <- exp(model$mean[7])
#Dalai Lamas
dl_int <- exp(model$mean[8])
#Japanese Emperor
je_int <- exp(model$mean[9])
#US Pres
us_int <- exp(model$mean[10])
```

