---
title: "World Leaders Lifespan"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
date: "8/23/2020"
output: 
  pdf_document:
      latex_engine: xelatex
---

NOTE: In order for the model code chunks to run in a reasonable time for models that do not exist, we shortened the RJAGs iterations to 2500. We recommend 150000-250000 iterations to ensure convergence. Additionally, if you are struggling to download RJags, please visit the following link for help. It can also help to try to download the package locally or in RStudio Cloud: https://sites.google.com/a/utexas.edu/edm-principalstratification/downloading-installing-r-jags-rstudio

# Loading In Packages and Data

```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r include=FALSE}
#Installing packages 
pkgTest("readr")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("knitr")
pkgTest("lubridate")
pkgTest("R2jags")
pkgTest("tidyr")
pkgTest("kableExtra")
pkgTest("tibble")
pkgTest("tidybayes")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(lubridate)
library(R2jags)
library(tidyr)
library(kableExtra)
library(tibble)
library(tidybayes)
```

```{r}
load("Leaders.Rdata")
leaders <- as.data.frame(leaders)
head(leaders)
```

# Update & Clean Data

There were some issues with the data-set when we initially began working with it. For one, the date was not properly updated to the most recent one. Further, the leaders Age.Event was a string with a numeric value & " days", when it should be just the numeric value (which is in fact, in years). Another modification that had to be made was to update the Event.Date and Age.Event to the current date for all samples that are still alive. Emperor Jianwen was marked as having not died in office, despite disappearing midway through their term, so we updated this value as well. Finally, we relevel the leader types for consistency across the code & results, with Pope as the baseline.

```{r}
prev_date <- as.Date("31/07/2020",format="%d/%m/%Y")
current_date <- as.Date("31/08/2020",format="%d/%m/%Y")

## remove days string and convert to numeric
leaders <- leaders %>% 
  mutate(Age.Event = sub(".*?(\\d+\\.*\\d*).*", "\\1", Age.Event)) %>% data.frame
leaders$Age.Event <- as.numeric(leaders$Age.Event)

## update age event by adding 1/12 to leaders still alive (none died in past month so easy to do case when)
leaders <- leaders %>% 
  mutate(Age.Event = case_when(Event.Date == prev_date ~ Age.Event + 1/12,
                               TRUE ~ Age.Event)) %>% data.frame

## update event dates to be current day since none of the leaders in this set died in the past month
leaders <- leaders %>% 
  mutate(Event.Date = case_when(Event.Date == prev_date ~ as.Date(current_date,format="%d/%m/%Y"),
                                TRUE ~ Event.Date)) %>% data.frame

## update Emperor Jianwen
leaders <- leaders %>% 
  mutate(Fail = case_when(Name == "Jianwen Emperor" ~ 1,
                          TRUE ~ Fail),
         Censored = case_when(Name == "Jianwen Emperor" ~ 0,
                          TRUE ~ Censored)) %>% data.frame

## relevel leadership types
leaders$Type <- factor(leaders$Type, levels =
                                  c("Pope","ChinaEmp","DalaiLama","JapanEmp","UsPres"))
```

# Exploratory Data Analysis

## Distribution of Relative Birth Date

```{r}
ggplot(leaders, aes(x=time)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Relative Birth Date") + xlab("Relative Birth Date")
```
## Distribution of Lifespan

```{r}
ggplot(leaders, aes(x=Age.Event)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Lifespan") + xlab("Lifespan (yrs)")
```

## Distributions of Relative Birth Date Across Leadership Type

```{r}
boxplot(time ~ Type, data = leaders, main="Relative Birth Date vs Type of Leader", ylab="Relative Birth Date", xlab="Leader Type")
```

## Distributions of Lifespan Across Leadership Type

```{r}
boxplot(Age.Event ~ Type, data = leaders, main="Lifespans vs Type of Leader", ylab="Lifespan (yrs)", xlab="Leader Type")
```

## Scatterplot of Lifespan vs Relative Birth Date across Leadership Type

```{r}
ggplot(leaders, aes(x=time, y=Age.Event, shape=Type, color=Type)) +
  geom_point() + labs(title="Lifespan vs Relative Birth Date") + 
  ylab("Lifespan (yrs)") + xlab("Relative Birth Date")
```


## Interaction Plot

```{r}
qplot(x = time, y = Age.Event, data = leaders, color = Type) +
  geom_smooth(method = "lm", se=FALSE) + ylab("Lifespan (yrs)") + xlab("Relative Birth Date")
```

# Modeling 

## Initialize Covariates and Predictive Information

Since we don't want to include the leaders we intend to predict lifespans for, we remove their names from the data-frame and create co-variates we'll need for RJAGS.

```{r}
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
filtered_leaders = leaders %>% 
  filter(!Name %in% alive)

n <- nrow(filtered_leaders)
Age.Event <- filtered_leaders$Age.Event
censored <- filtered_leaders$Censored
survival <- ifelse(censored == 0, Age.Event, NA)
censoring_limits <- ifelse(censored == 0, 100, Age.Event)

# Co-variates
x_1 <- filtered_leaders$time - mean(filtered_leaders$time)
x_2 <- filtered_leaders$Type
```

For the four leaders we intend to make predictions for, we need the following information: their mean-centered birthday, their leadership type (numeric indicators for level), and current age. Their current age is necessary since our distribution will truncate the predictions in a manner that prevents the model from predicting lifespans below their current age. The upper_age variable is the upper bound truncation we use for making predictions for leaders who are already dead. Our paper goes into more detail about this decision for an upper boundary, but you can read more here about supercentenarians: http://supercentenarian-research-foundation.org/.

```{r}
# predictive info for Francis, Obama, and Naruhito
# 1 = Pope, 2 = ChineseEmp, 3 = DalaiLama, 4 = JapanEmp, 5 = UsPres
#Dalai Lama
time_DL <- 6.3549350 - mean(filtered_leaders$time)
type_DL <- 3
present_age_DL <- 85.153833

#Francis
time_Francis <- 6.3694456 - mean(filtered_leaders$time)
type_Francis <- 0
present_age_Francis <- 83.702772

#Obama
time_Obama <- 6.6157426 - mean(filtered_leaders$time)
type_Obama <- 5
present_age_Obama <- 59.073066

#Naruhito
time_Naruhito <- 6.6012868 - mean(filtered_leaders$time)
type_Naruhito <- 4
present_age_Naruhito <- 60.518652

present_age <- ifelse(censored == 0, 0, filtered_leaders$Age.Event)
upper_age <- 110
```

The following variables are used as inputs into the model to create it. This includes the predictive information for the leaders we removed from the dataframe, the censoring information, survival, and covariates (centered birth, leadership type).

```{r}
data_leaders <- list("n",
                     "censored",
                     "survival",
                     "censoring_limits",
                     "x_1",
                     "x_2", 
                     "present_age",
                     "upper_age",
                     "time_Francis",
                     "present_age_Francis",
                     "time_Obama",
                     "type_Obama",
                     "present_age_Obama",
                     "time_DL",
                     "type_DL",
                     "present_age_DL",
                     "time_Naruhito",
                     "type_Naruhito",
                     "present_age_Naruhito")
```

## Utility Functions for Generating RJAGs Models

RJAGs allows users to input either the text of the model they hope to create (where information such as likelihood, priors, and predictive information instructions are necessary) or input an R function. To minimize code duplication, the following method concatenates the likelihood information, prior specification, and predictive information. Anyone who wishes to build off of these results can input the priors (see sections Model 1a - Model 6b for various examples).

```{r}
generate_model_text = function(priors=""){
  model_file <- tempfile()
  
  likelihood = "#Likelihood
  for (i in 1:n){ 
    censored[i] ~ dinterval(survival[i], censoring_limits[i]) 
    survival[i] ~ dweib(r, mu[i]) # Basic Weibull assumption
    mu[i] <- exp(beta[i])  # Defining beta as log(mu)
    beta[i] <- beta_0 + beta_1*x_1[i] + beta_type[x_2[i]] + beta_int[x_2[i]] * x_1[i] 
    y_pred_censored[i] ~ dweib(r, mu[i])T(present_age[i], upper_age)
  }
    
  #Priors
  beta_type[1] <- 0
  beta_int[1] <- 0
  "
  
  predicted_survivals = "
  #Define the alphas
  alpha_0 <- - beta_0 / r
  alpha_1 <- - beta_1 / r
  percentage_increase_birthyr <- 100*(exp(alpha_1) - 1)
  for (i in 2:5) {
    alpha_type[i] <- - beta_type[i] / r
    alpha_int[i] <- -beta_int[i] / r
    percentage_increase_type[i] <- 100*(exp(alpha_type[i]) - 1)
    percentage_increase_int[i] <- 100*(exp(alpha_int[i]) - 1)
  }
  
  beta_Francis <- beta_0 + beta_1*time_Francis 
  mu_Francis <- exp(beta_Francis)
  survival_Francis ~ dweib(r, mu_Francis)T(present_age_Francis, upper_age)
  
  beta_Obama <- beta_0 + beta_1*time_Obama + 
    beta_type[type_Obama] + beta_int[type_Obama]*time_Obama
  mu_Obama <- exp(beta_Obama)
  survival_Obama ~ dweib(r, mu_Obama)T(present_age_Obama, upper_age)
  
  beta_Naruhito <- beta_0 + beta_1*time_Naruhito + beta_type[type_Naruhito] +
    beta_int[type_Naruhito]*time_Naruhito
  mu_Naruhito <- exp(beta_Naruhito)
  survival_Naruhito ~ dweib(r, mu_Naruhito)T(present_age_Naruhito, upper_age)
  
  beta_DL <- beta_0 + beta_1*time_DL + beta_type[type_DL] + beta_int[type_DL]*time_DL
  mu_DL <- exp(beta_DL)
  survival_DL ~ dweib(r, mu_DL)T(present_age_DL, upper_age)
  "
  
  model_text <- paste("model{ ",likelihood, priors, predicted_survivals, "}")
  writeLines(model_text,con=model_file)
  return(model_file)
}
```

The following utility function takes in the priors and name of the model file the user intends to create before running RJAGS. In the case the model_name exists in the current working directory, this function will instead load in that model and return it for further exploration.

```{r}
generate_model = function(priors,model_name){
  model_file <- generate_model_text(priors)
  if (file.exists(model_name)) {
    load(file = model_name)
  } 
  else {
    
    rjags_model <- jags(data = data_leaders,  
                        parameters.to.save = c("beta_0",
                                               "beta_1",
                                               "beta_type",
                                               "beta_int",
                                               "r",
                                               "y_pred_censored",
                                               "survival_Francis",
                                               "survival_Obama",
                                               "survival_Naruhito",
                                               "survival_DL",
                                               "alpha_0",
                                               "alpha_1",
                                               "percentage_increase_birthyr",
                                               "alpha_type",
                                               "alpha_int",
                                               "percentage_increase_type",
                                               "percentage_increase_int",
                                               "survival"
                        ), 
                        n.iter = 2500, #increase for better model output - 250K
                        n.chains = 3,
                        model.file = model_file)
    save(rjags_model, file = model_name)
  }
  return(rjags_model)
}
```

# Models

## Note: Increase n.iter in generate_model function when creating new models from default 2500

## Model From Paper, Original Id: 6a

This was the model we ultimately selected for the paper. The following sections include some of the other ones we explored, so readers can see a variety of ways to use the generate_model function.

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dgamma(25,0.2) # Prior on 
  "
Bayesian_Leaders_output <- generate_model(priors,"leaders_model_r_25_2e-1_beta_1.Rdata")
```

## Model 1a: r ~ exp(0.001), Betas ~ N(0,1)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, 1) # Prior on beta_1 is normal with low precision
  
  # http://mikemeredith.net/blog/2017/Categories_in_JAGS.htm
  # potentially set different prior for dalai lamas (negative mean or somethin)
  
  r ~ dexp(0.001) # Prior on r
  "
Bayesian_Leaders_V1a <- generate_model(priors,"leaders_model_r_1e-3_beta_1.Rdata")
```

## Model 1b: r ~ exp(0.001), Betas ~ N(0,100)

NOTE: For rjags, it treats the second input into the dnorm function as precision when parsing. For this reason, all priors of Betas ~ N(0,100) have dnorm(0.0,0.1) in the prior text.

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, .01)
    beta_int[i] ~ dnorm(0.0, .01)
  }
  
  beta_0 ~ dnorm(0.0, .01) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, .01) # Prior on beta_1 is normal with low precision
  
  # http://mikemeredith.net/blog/2017/Categories_in_JAGS.htm
  # potentially set different prior for dalai lamas (negative mean or somethin)
  
  r ~ dexp(0.001) # Prior on r
  "
Bayesian_Leaders_V1b <- generate_model(priors,"leaders_model_r_1e-3_beta_100.Rdata")
```

## Model 2a - r ~ exp(0.1), Betas ~ N(0,1)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(0.1) # Prior on r
  "
Bayesian_Leaders_V2a <- generate_model(priors,"leaders_model_r_1e-1_beta_1.Rdata")
```

## Model 2b - r ~ exp(0.1), Betas ~ N(0,100)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, .01)
    beta_int[i] ~ dnorm(0.0, .01)
  }
  
  beta_0 ~ dnorm(0.0, .01)
  beta_1 ~ dnorm(0.0, .01)
  
  r ~ dexp(0.1) # Prior on r
  "
Bayesian_Leaders_V2b <- generate_model(priors,"leaders_model_r_1e-1_beta_100.Rdata")
```


## Model 3a - r ~ exp(1), Betas ~ N(0,1)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(1) # Prior on r
  "
Bayesian_Leaders_V3a <- generate_model(priors,"leaders_model_r_1_beta_1.Rdata")
```

## Model 3b - r ~ exp(1), Betas ~ N(0,100)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 100)
    beta_int[i] ~ dnorm(0.0, 100)
  }
  
  beta_0 ~ dnorm(0.0, .01)
  beta_1 ~ dnorm(0.0, .01)
  
  r ~ dexp(1) # Prior on r
  "
Bayesian_Leaders_V3b <- generate_model(priors,"leaders_model_r_1_beta_100.Rdata")
```


## Model 4a - r ~ exp(2), Betas ~ N(0,1)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dexp(2) # Prior on r
  "
Bayesian_Leaders_V4a <- generate_model(priors,"leaders_model_r_2_beta_1.Rdata")
```

## Model 4b - r ~ exp(2), Betas ~ N(0,100)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)
  
  r ~ dexp(2) # Prior on r
  "
Bayesian_Leaders_V4b <- generate_model(priors,"leaders_model_r_2_beta_100.Rdata")
```

## Model 5a - r ~ gamma(10,0.5), Betas ~ N(0,1)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1)
    beta_int[i] ~ dnorm(0.0, 1)
  }
  
  beta_0 ~ dnorm(0.0, 1)
  beta_1 ~ dnorm(0.0, 1)
  
  r ~ dgamma(10,0.5) # Prior on r
  "
Bayesian_Leaders_V5a <- generate_model(priors,"leaders_model_r_10_5e-1_beta_1.Rdata")
```

## Model 5b - r ~ gamma(10,0.5), Betas ~ N(0,100)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)
  
  r ~ dgamma(10,0.5) # Prior on r
  "
Bayesian_Leaders_V5b <- generate_model(priors,"leaders_model_r_10_5e-1_beta_100.Rdata")
```

## Model 6b - r=gamma(25,0.2), Betas: N(0,100)

```{r}
priors <- "
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 0.01)
    beta_int[i] ~ dnorm(0.0, 0.01)
  }
  
  beta_0 ~ dnorm(0.0, 0.01)
  beta_1 ~ dnorm(0.0, 0.01)
  
  r ~ dgamma(25,0.2) # Prior on r
  "
Bayesian_Leaders_V6b <- generate_model(priors,"leaders_model_r_25_2e-1_beta_100.Rdata")
```

# Model Evaluation

You must run the following chunk to ensure the to-be-evaluated model is loaded into the environment.
```{r}
final_model_name <- "leaders_model_r_25_2e-1_beta_1.Rdata"
if (file.exists(final_model_name)) {
    load(file = final_model_name)
    Bayesian_Leaders_output <- rjags_model
}else {
  print(paste0(final_model_name), " is not in the workspace.")
}
```

## Traceplots 

The following plots output traceplots of the different parameters and coefficients used in this model in order to verify those values have converged.

```{r fig.height=4, fig.align='center'}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), r, beta_0, beta_1) %>% 
  ungroup() %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ",beta[0], ", ", beta[1], ", and r")), 
       x = "Iteration", y = "Value", color = "Chain")
```


```{r fig.height=4, fig.align='center'}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_type[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["2j"], " (coefficients for Type)")), 
       x = "Iteration", y = "Value",color = "Chain")
```


```{r fig.height=4}
tidybayes::gather_draws(Bayesian_Leaders_output %>% coda::as.mcmc(), beta_int[i]) %>% 
  ungroup() %>% 
  filter(i > 1) %>% 
  mutate(.variable = ifelse(is.na(i), .variable, paste0(.variable, "[",i, "]"))) %>% 
  # tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = .iteration, y = .value, color = as.factor(.chain)), alpha = 0.7) + 
  facet_grid(.variable~., scales = "free_y") + 
  labs(title = expression(paste("Traceplots of ", beta["3j"], " (coefficients for Type * Time)")), 
       x = "Iteration", y = "Value", color = "Chain")
```

## Auto correlation Functions

The following plots verify that the sampled values of the parameters and coefficients are not highly correlated with one another, which provides evidence that we were able to sufficiently explore the space of possible values of those arguments.

```{r}
plot_acf <- function(parameter) {
  Bayesian_Leaders_output$BUGSoutput$sims.matrix %>% 
    as_tibble() %>% 
    pull(parameter) %>% 
    acf()
}
for (param in c("r","beta_0", "beta_1", 
                "beta_type[2]", "beta_type[3]", "beta_type[4]", "beta_type[5]", 
                "beta_int[2]", "beta_int[3]", "beta_int[4]", "beta_int[5]")) {
  plot_acf(param)
}
```

## Sensitivity Analysis

The following plots check for prior sensitivity of Pope Francis's predicted age across eight of the priors we tested, with two of the exponential priors for r and two of the gamma priors for r.

```{r}
r_vals <- c("1e-3", "1", "10_5e-1", "25_2e-1")
b_vals <- c("1", "100")
r = r_vals[1]
b = b_vals[1]
file_name = paste0("leaders_model_r_",r,"_beta_",b,".Rdata")
load(file_name)
df <- as.data.frame(Bayesian_Leaders_output$BUGSoutput$sims.matrix)
files_all_available = TRUE

sensitivity_df = data.frame()
for (r in r_vals) {
  for (b in b_vals) {
    file_name = paste0("leaders_model_r_",r,"_beta_",b,".Rdata")
    if (file.exists(file_name)) {
      load(file_name)
      df = Bayesian_Leaders_output$BUGSoutput$sims.matrix %>% as.data.frame() %>%
        select(survival_Francis) %>% mutate(r = (paste0("r = ", r, " beta = ", b)))
      sensitivity_df = sensitivity_df %>% bind_rows(df)
    } else {
      files_all_available = FALSE
      break
    }
  }
}
if (files_all_available){
  sensitivity_df %>%  ggplot() + geom_density(aes(x = survival_Francis)) + facet_wrap(r~., scales = "free")
} else{
  print("Not all files for priors were available - please check your environment, r_vals, and b_vals")
}
```

# Answering Questions

```{r}
# probability that the 14th Dalai Lama will have a longer lifespan than Pope Francis

survival_DL <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_DL"]
survival_Francis <-Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Francis"]

DL_vs_francis <- survival_DL - survival_Francis
DL_vs_francis_data <- as.data.frame(DL_vs_francis)
ggplot(DL_vs_francis_data, aes(x = DL_vs_francis, y = ..density..)) + geom_histogram(binwidth = 3) + labs(x = "Difference in Predicted Survival Times (Dali Lama - Francis)", y = "Predictive Probability density", title = "Distribution of Difference in Predicted Survival Times for Dali Lama and Pope Francis") +  theme_light() + geom_vline(xintercept=mean(DL_vs_francis), color = "blue")

```


```{r}
#probability that Obama will live longer thatn Naruhito

survival_Obama <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Obama"]
survival_Naruhito <- Bayesian_Leaders_output$BUGSoutput$sims.matrix[,"survival_Naruhito"]

Obama_vs_naruhito <- survival_Obama - survival_Naruhito
Obama_vs_naruhito_data <- as.data.frame(Obama_vs_naruhito)
ggplot(Obama_vs_naruhito_data, aes(x = Obama_vs_naruhito, y = ..density..)) + geom_histogram(binwidth = 3) + labs(title ="Distribution of Difference in Predicted Survival Times for President Obama and Emperor Naruhito" ,x = "Difference in Predicted Survival Times (Obama - Naruhito)", y = "Predictive Probability density")  +  theme_light() + geom_vline(xintercept=mean(Obama_vs_naruhito), color = "blue") 
```


#Interaction Interpretation Table

```{r}
model <- Bayesian_Leaders_output$BUGS$summary %>% as.data.frame()

#Pope
pope_alpha <- c(model$`2.5%`[2], model$mean[2], model$`97.5%`[2])
pope_multiplicative_difference <- exp(0.1*pope_alpha)
pope_percent_difference <- 100*(pope_multiplicative_difference - 1)


#Chinese Emperors
ce_alpha <- c(model$`2.5%`[2] + model$`2.5%`[3], model$mean[2] + model$mean[3], model$`97.5%`[2] + model$`97.5%`[3])
ce_multiplicative_difference <- exp(0.1*ce_alpha)
ce_percent_difference <- 100*(ce_multiplicative_difference - 1)

#Dalai Lama
dl_alpha <- c(model$`2.5%`[2] + model$`2.5%`[4], model$mean[2] + model$mean[4], model$`97.5%`[2] + model$`97.5%`[4])
dl_multiplicative_difference <- exp(0.1*dl_alpha)
dl_percent_difference <- 100*(dl_multiplicative_difference - 1)

#Japanese Emperor

je_alpha <- c(model$`2.5%`[2] + model$`2.5%`[5], model$mean[2] + model$mean[5], model$`97.5%`[2] + model$`97.5%`[5])
je_multiplicative_difference <- exp(0.1*je_alpha)
je_percent_difference <- 100*(je_multiplicative_difference - 1)

#US Presidents

us_alpha <- c(model$`2.5%`[2] + model$`2.5%`[6], model$mean[2] + model$mean[6], model$`97.5%`[2] + model$`97.5%`[6])
us_multiplicative_difference <- exp(0.1*us_alpha)
us_percent_difference <- 100*(us_multiplicative_difference - 1)


Type <- c("Pope", "Chinese Emperor", "Dalai Lama", "Japanese Emperor", "US President")
Multiplicative_Scale_Factor <- data.frame(Type, t(data.frame(pope_multiplicative_difference, ce_multiplicative_difference, dl_multiplicative_difference, je_multiplicative_difference, us_multiplicative_difference))) 
Percent_Difference <- data.frame(Type, t(data.frame(pope_percent_difference, ce_percent_difference, dl_percent_difference, je_percent_difference, us_percent_difference)))

bind_rows(Multiplicative_Scale_Factor,
          Percent_Difference) %>% 
  tibble::rownames_to_column() %>% 
  mutate_if(is.numeric, round, digits=3) %>% 
  mutate(Mean = X2, 
         `95% CI` = paste0("(", X1, ", ", X3, ")")) %>% 
  select(-(X1:X3), -rowname) %>% 
  kableExtra::kable(booktabs = TRUE, 
                    caption = "Posterior Predictions for Lifespans of Living Leaders", 
                    col.names = c("Leadership Type", "Mean", "95% CI")) %>% 
  pack_rows("Multiplicative Difference", 1,5) %>% 
  pack_rows("Percent Difference", 6,10)
```
```{r}
modelOutput <- Bayesian_Leaders_output$BUGSoutput$summary %>% as.data.frame()
survivalPredicted <- modelOutput[211:383, ] %>% select("mean", "sd", "2.5%", "50%", "97.5%")
#creating dataframe with useful information (including prediction residuals and standardized residuals)
leader <- filtered_leaders$Name
censored_value <- as.factor(filtered_leaders$Censored)
actual_survival <- filtered_leaders$Age.Event
time <- filtered_leaders$time
survivalPredicted <- survivalPredicted %>%
  mutate(actual = actual_survival) %>%
  mutate(name = leader) %>%
  mutate(Censored = censored_value) %>%
  mutate(Standardized_Residual = (actual-mean)/sd) %>%
  mutate(Residual = actual-mean) %>%
  mutate(time_of_birth = time)
```

```{r}
#qqplot of residuals
qqnorm(survivalPredicted$Residual)
```



```{r}
#standardized residual plot
shapes = c(16, 4) 
shapes <- shapes[as.numeric(survivalPredicted$Censored)]
plot(y = survivalPredicted$Standardized_Residual, x = survivalPredicted$time_of_birth, col= survivalPredicted$Censored, pch = shapes, main = "Standardized Residuals vs Time", xlab = "Time", ylab = "Standardized Residuals")
abline(h =0)
legend("topleft", legend = c("Censored", "Non-Censored"),
      col =  c("black", "red"),
      pch = c(16, 4), cex = 0.75)
```


```{r}
shapes = c(16, 4) 
shapes <- shapes[as.numeric(survivalPredicted$Censored)]
plot(survivalPredicted$Standardized_Residual, col= x_2, pch = shapes,  main = "Standardized Residuals vs Type", xlab = "Type", ylab = "Standardized Residuals")
abline(h =0)
legend("bottomleft", legend = c("Popes", "US President", "Chinese Emperor", "Dalai Lama", "Japanese Emperor", "Censored"),
      col =  c("black", "cyan", "red", "green", "blue", "grey5"),
      pch = c(16, 16, 16, 16, 16, 4), cex = 0.7)
``` 

