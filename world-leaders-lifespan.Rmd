---
title: "World Leaders Lifespan"
author: "Ethan Shen, Malavi Ravindran, Steven Herrera Tenorio, Anna Darwish"
date: "8/23/2020"
output: html_document
---

```{r, function checking for installed packages, include=FALSE}
pkgTest <- function(x)
  {
    if (!require(x,character.only = TRUE))
    {
      install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
        if(!require(x,character.only = TRUE)) stop("Package not found")
    }
  }
```

```{r include=FALSE}
#Installing packages 
pkgTest("readr")
pkgTest("dplyr")
pkgTest("ggplot2")
pkgTest("Epi")
pkgTest("knitr")
pkgTest("lubridate")
pkgTest("R2jags")
pkgTest("tidyr")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(Epi)
library(knitr)
library(lubridate)
library(R2jags)
library(tidyr)
```

```{r}
load("Leaders.Rdata")
leaders <- as.data.frame(leaders)
head(leaders)
```

# Update Data

```{r}
prev_date <- as.Date("31/07/2020",format="%d/%m/%Y")
current_date <- as.Date("31/08/2020",format="%d/%m/%Y")

## remove days string and convert to numeric
leaders <- leaders %>% 
  mutate(Age.Event = sub(".*?(\\d+\\.*\\d*).*", "\\1", Age.Event)) %>% data.frame
leaders$Age.Event <- as.numeric(leaders$Age.Event)

## update age event by adding 1/12 to leaders still alive (none died in past month so easy to do case when)
leaders <- leaders %>% 
  mutate(Age.Event = case_when(Event.Date == prev_date ~ Age.Event + 1/12,
                               TRUE ~ Age.Event)) %>% data.frame

## update event dates to be current day since none of the leaders in this set died in the past month
leaders <- leaders %>% 
  mutate(Event.Date = case_when(Event.Date == prev_date ~ as.Date(current_date,format="%d/%m/%Y"),
                                TRUE ~ Event.Date)) %>% data.frame

## update Emperor Jianwen
leaders <- leaders %>% 
  mutate(Fail = case_when(Name == "Jianwen Emperor" ~ 1,
                          TRUE ~ Fail)) %>% data.frame

## multiplying time by 10 
leaders <- leaders %>% 
  mutate(decade = time * 10)
```

# Exploratory Data Analysis

## Distribution of Relative Birth Date

```{r}
ggplot(leaders, aes(x=decade)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Relative Birth Date") + xlab("Relative Birth Date")
```
## Distributions of Lifespan

```{r}
ggplot(leaders, aes(x=Age.Event)) + 
  geom_histogram(color="black", fill="white", bins = 10) + 
  labs(title="Distribution of Lifespan") + xlab("Lifespan (yrs)")
```

## Distributions of Relative Birth Date Across Leadership Type

```{r}
boxplot(time ~ Type, data = leaders, main="Relative Birth Date vs Type of Leader", ylab="Relative Birth Date", xlab="Leader Type")
```

## Distributions of Lifespan Across Leadership Type

```{r}
boxplot(Age.Event ~ Type, data = leaders, main="Lifespans vs Type of Leader", ylab="Lifespan (yrs)", xlab="Leader Type")
```

## Scatterplot of Lifespan vs Relative Birth Date across Leadership Type

```{r}
ggplot(leaders, aes(x=time, y=Age.Event, shape=Type, color=Type)) +
  geom_point() + labs(title="Lifespan vs Relative Birth Date") + 
  ylab("Lifespan (yrs)") + xlab("Relative Birth Date")
```


## Interaction Plot

```{r}
qplot(x = time, y = Age.Event, data = leaders, color = Type) +
  geom_smooth(method = "lm", se=FALSE) + ylab("Lifespan (yrs)") + xlab("Relative Birth Date")
```

## Lexis Diagrams of Lifespans Across Leadership Type

```{r}
leaderTypeTitles <- c("Popes", "US Presidents", "Chinese Emperors", "Dalai Lamas","Japanese Emperors")
names(leaderTypeTitles) <- c("Pope", "UsPres", "ChinaEmp","DalaiLama","JapanEmp")

plotLifeSpan <- function(leaderType) {
  leaders.lexis <- leaders %>% filter(Type == leaderType) %>% data.frame
  
  # Used code from http://search.r-project.org/library/Epi/html/plot.Lexis.html to generate lexis plot
  leaders.lexis$bt <- as.integer(substring(leaders.lexis$Birth.Date,0,4))
  leaders.lexis$ex <- as.integer(substring(leaders.lexis$Event.Date,0,4))
  
  # Define as Lexis object with timescales calendar time and age
  lifespans <- Lexis( entry = list( per=bt ),
                      exit = list( per=ex, age=Age.Event ),
                      exit.status = Fail,
                      data = leaders.lexis )
  plotTitle = paste0("Lexis Diagram of Lifespans of ",leaderTypeTitles[leaderType])
  plot(lifespans, grid=0:20*5, col='black', xaxs="i", yaxs="i",
       xlim=c(min(leaders.lexis$bt),2030), ylim=c(0,100), lwd=3, las=1 , main=plotTitle,
       ylab="Lifespan (yrs)", xlab="Century") 
  points( lifespans, pch=c(NA,16)[lifespans$lex.Xst+1], col="red", cex=1.5 )
}

for (leaderType in unique(leaders$Type)) {
  plotLifeSpan(leaderType)
}

```


# Modeling 

```{r}
alive = c("Barack Obama","Francis","14th Dalai Lama (Tenzin Gyatso)", "Naruhito (Emperor Reiwa)")
l = leaders[-(leaders$Name %in% alive),]
l

n <- nrow(l)
#
#
# Censoring
Age.Event <- l$Age.Event
#
censored <- l$Censored
#
survival <- ifelse(censored == 0, Age.Event, NA)
#
censoring_limits <- ifelse(censored == 0, 100, Age.Event)
#
# Covariates (centered)
#
x_1 <- l$time - mean(l$time) # looking at "time" by the decade 
#
x_2 <- l$Type %>% as.factor() %>% relevel("Pope")

#leaders[leaders$Name == "Francis",]$time
```
pope is baseline for type 
```{r}
leaders_model <- function() {
  for(i in 1:n){
    censored[i] ~ dinterval(survival[i], censoring_limits[i]) 
    survival[i] ~ dweib(r, mu[i]) # Basic Weibull assumption
    mu[i] <- exp(beta[i])  # Defining beta as log(mu)
    beta[i] <- beta_0 + beta_1*x_1[i] + beta_type[x_2[i]] + beta_inter[x_2[i]] * x_1[i] 
  }
  
  # Priors
  #
  beta_0 ~ dnorm(0.0, 1.0E-4) # Prior on beta_0 is normal with low precision
  beta_1 ~ dnorm(0.0, 1.0E-4) # Prior on beta_1 is normal with low precision
  
  # http://mikemeredith.net/blog/2017/Categories_in_JAGS.htm
  # potentially set different prior for dalai lamas (negative mean or somethin)
  
  beta_type[1] <- 0
  beta_inter[1] <- 0
  
  for(i in 2:5) {
    beta_type[i] ~ dnorm(0.0, 1.0E-4)
    beta_inter[i] ~ dnorm(0.0, 1.0E-4)
  }
  
  r ~ dexp(0.001) # Prior on r
  
  
  # Predictive distribution of age at the new values
  #
  beta_Francis <- beta_0 + beta_1*age_Francis + beta_type[1] 
  mu_Francis <- exp(beta_Francis)
  survival_Francis ~ dweib(r, mu_Francis) %_% T(present_length, upper_length)
  # Take into account the current pontificate length
  # Also specify a sensible upper bound
  #age_Francis_predictive <- age_at_election + survival_Francis
  # Work also with age
}
```

```{r}
###### unsure if this is right ####
#age_at_election <- leaders[leaders$Name == "Francis",]$Age.Event
age_Francis <- leaders[leaders$Name == "Francis",]$time

#year_Francis <- 2013 - mean(popes$Year.Elected)
#
#
# Predictive distribution of pontificate length for Francis at election
# Conditional on being greater than 3.79 years (December 2016)
#
present_length <- leaders[leaders$Name == "Francis",]$Age.Event

upper_length <- 100
#############
data_leaders <- list("n",
                     "censored",
                     "survival",
                     "censoring_limits",
                     "x_1",
                     "x_2",
                     #"age_at_election",
                     "age_Francis",
                     "present_length",
                     "upper_length")
#
Bayesian_Leaders <- jags(data = data_leaders,  
                         parameters.to.save = c("beta_0",
                                                "beta_1",
                                                "beta_type",
                                                "beta_inter",
                                                "r",
                                                "survival_Francis"
                                                #,
                                                #"age_Francis_predictive"
                         ), 
                         n.iter = 150000, # INCREASE SIMULATIONS
                         n.burnin = 50000,
                         n.thin = 100, 
                         n.chains = 3,
                         model.file = leaders_model)
Bayesian_Leaders
```

## Traceplots 

```{r}
post_values = Bayesian_Leaders$BUGSoutput$sims.matrix %>% 
  as.data.frame() %>% 
  mutate(i = row_number())

post_values %>% 
  tidyr::gather(key, value, "beta_0", "beta_1", "r", -i) %>% 
  ggplot() + 
  geom_line(aes(x = i, y = value, color = key)) + 
  facet_grid(key~., scales = "free_y")

post_values %>% 
  tidyr::gather(key, value, `beta_type[2]`:`beta_type[5]`, -i) %>% 
  ggplot() + 
  geom_line(aes(x = i, y = value, color = key)) + 
  facet_grid(key~., scales = "free_y")

post_values %>% 
  tidyr::gather(key, value, `beta_inter[2]`:`beta_inter[5]`, -i) %>% 
  ggplot() + 
  geom_line(aes(x = i, y = value, color = key)) + 
  facet_grid(key~., scales = "free_y")
```

## Posterior Predictive Distribution (Francis' Lifespan)

```{r}
ggplot(post_values) +
  geom_histogram(aes(x = survival_Francis)) # this kinda makes sense?? I guess we wnat things to look "approx normal"
```


